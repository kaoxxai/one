<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒè³‡æœ¬ç´€å…ƒ (Capital Epoch) - 2037</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+TC:wght@300;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .cyber-font {
            font-family: 'Orbitron', sans-serif;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .asset-card {
            transition: all 0.3s ease;
        }
        .asset-card:hover {
            transform: translateY(-2px);
            border-color: #3b82f6;
        }

        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .hidden { display: none; }
        
        .news-ticker-wrap {
            overflow: hidden;
            white-space: nowrap;
        }
        .news-ticker {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 p-4 flex justify-between items-center shadow-lg z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded flex items-center justify-center text-xl font-bold">CE</div>
            <div>
                <h1 class="text-xl font-bold cyber-font tracking-wider text-blue-400">CAPITAL EPOCH</h1>
                <p class="text-xs text-slate-400">å…¨çƒè³‡æœ¬ç´€å…ƒ v1.0 | 2037 AD</p>
            </div>
        </div>
        <div class="flex gap-8 text-sm">
            <div class="text-center">
                <div class="text-slate-400">å›åˆ (Round)</div>
                <div class="text-xl font-bold cyber-font" id="round-display">1 / 10</div>
            </div>
            <div class="text-center">
                <div class="text-slate-400">ç¾é‡‘ (Cash)</div>
                <div class="text-xl font-bold text-green-400 cyber-font" id="cash-display">$100,000</div>
            </div>
            <div class="text-center">
                <div class="text-slate-400">ç¸½è³‡ç”¢ (NAV)</div>
                <div class="text-xl font-bold text-yellow-400 cyber-font" id="nav-display">$100,000</div>
            </div>
        </div>
        <button onclick="game.showHelp()" class="p-2 bg-slate-800 rounded hover:bg-slate-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 11 18 0z" />
            </svg>
        </button>
    </header>

    <!-- Main Game Area -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left: Market & Assets -->
        <section class="w-2/5 p-4 overflow-y-auto border-r border-slate-700 bg-slate-900/50">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-blue-300 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/></svg>
                    è³‡ç”¢å¸‚å ´ (Market)
                </h2>
                <span class="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded">é»æ“Šäº¤æ˜“</span>
            </div>
            <div id="market-grid" class="grid gap-3">
                <!-- Asset Cards injected by JS -->
            </div>
        </section>

        <!-- Center: Info & Chart -->
        <section class="w-2/5 p-4 flex flex-col gap-4 bg-slate-800/30">
            <!-- News Ticker -->
            <div class="glass-panel p-2 rounded border-l-4 border-yellow-500">
                <div class="text-xs text-yellow-500 font-bold mb-1">å…¨çƒå¿«è¨Š (GLOBAL NEWS)</div>
                <div class="news-ticker-wrap">
                    <div id="news-ticker" class="news-ticker text-sm">æ­£åœ¨é€£ç·šè‡³å…¨çƒè³‡æœ¬ç¶²çµ¡...</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="glass-panel p-4 rounded flex-1 flex flex-col">
                <h3 class="text-sm font-bold text-slate-400 mb-2">åƒ¹æ ¼èµ°å‹¢ (Price History)</h3>
                <div class="flex-1 relative w-full">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Insider Info & Event -->
            <div class="glass-panel p-4 rounded h-1/3 flex flex-col">
                <h3 class="text-sm font-bold text-purple-400 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/></svg>
                    æƒ…å ±èˆ‡è¡Œå‹• (Intel & Actions)
                </h3>
                <div id="intel-panel" class="flex-1 overflow-y-auto text-sm space-y-2 mb-3 p-2 bg-black/20 rounded">
                    <!-- Intel Content -->
                </div>
                <button id="next-turn-btn" onclick="game.nextTurn()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded font-bold shadow-lg transition transform active:scale-95">
                    çµæŸå›åˆ (End Round)
                </button>
            </div>
        </section>

        <!-- Right: Portfolio -->
        <section class="w-1/5 p-4 border-l border-slate-700 bg-slate-900/80 overflow-y-auto">
            <h2 class="text-lg font-bold text-green-300 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg>
                æˆ‘çš„æŒå€‰ (Portfolio)
            </h2>
            
            <!-- Role Info -->
            <div class="mb-6 p-3 bg-slate-800 rounded border border-slate-600">
                <div class="text-xs text-slate-400">è·æ¥­ (Role)</div>
                <div id="role-name" class="font-bold text-blue-400">--</div>
                <div id="role-desc" class="text-xs text-slate-500 mt-1">--</div>
            </div>

            <div id="portfolio-list" class="space-y-3">
                <!-- Portfolio items -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    
    <!-- Role Selection Modal -->
    <div id="role-modal" class="modal">
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-600 max-w-4xl w-full m-4 shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-2 text-white cyber-font">é¸æ“‡ä½ çš„èº«ä»½</h2>
            <p class="text-center text-slate-400 mb-8">2037 å…¨çƒè³‡æœ¬ç´€å…ƒï¼Œä½ çš„å°ˆé•·å°‡æ±ºå®šä½ çš„ç”Ÿå­˜æ–¹å¼ã€‚</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Roles injected here -->
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="trade-modal" class="modal hidden">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 w-96 shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="trade-asset-name" class="text-xl font-bold text-white">Asset Name</h3>
                    <p id="trade-asset-price" class="text-lg text-blue-400 cyber-font">$0</p>
                </div>
                <button onclick="ui.closeTradeModal()" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            
            <div class="bg-slate-900 p-3 rounded mb-4">
                <p class="text-xs text-slate-400">æŒæœ‰æ•¸é‡: <span id="trade-owned" class="text-white">0</span></p>
                <p class="text-xs text-slate-400">æœ€å¤§å¯è²·: <span id="trade-max-buy" class="text-white">0</span></p>
            </div>

            <div class="flex items-center justify-center gap-4 mb-6">
                <button onclick="game.adjustTradeAmount(-1)" class="w-8 h-8 bg-slate-700 rounded hover:bg-slate-600">-</button>
                <input id="trade-amount" type="number" value="1" min="1" class="w-20 bg-slate-900 border border-slate-700 rounded p-1 text-center text-white">
                <button onclick="game.adjustTradeAmount(1)" class="w-8 h-8 bg-slate-700 rounded hover:bg-slate-600">+</button>
            </div>

            <p class="text-center text-sm mb-4 text-slate-300">ç¸½é‡‘é¡: <span id="trade-total" class="text-yellow-400 cyber-font">$0</span></p>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="game.executeTrade('buy')" class="bg-green-600 hover:bg-green-500 py-2 rounded font-bold text-white">è²·å…¥ (Buy)</button>
                <button onclick="game.executeTrade('sell')" class="bg-red-600 hover:bg-red-500 py-2 rounded font-bold text-white">è³£å‡º (Sell)</button>
            </div>
        </div>
    </div>

    <!-- End Game Modal -->
    <div id="end-modal" class="modal hidden">
        <div class="bg-slate-800 p-8 rounded-xl border border-yellow-500 max-w-lg w-full text-center">
            <h2 class="text-3xl font-bold text-yellow-500 mb-4 cyber-font">GAME OVER</h2>
            <p class="text-slate-300 mb-6">2037 è²¡æ”¿å¹´åº¦å·²çµæŸã€‚</p>
            
            <div class="bg-slate-900 p-6 rounded mb-6">
                <div class="text-slate-400 text-sm">æœ€çµ‚è³‡ç”¢æ·¨å€¼ (NAV)</div>
                <div id="final-score" class="text-4xl font-bold text-white cyber-font my-2">$0</div>
                <div id="final-rank" class="text-green-400 font-bold text-xl">æŠ•è³‡å‚³å¥‡</div>
            </div>

            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded font-bold text-white w-full">é‡æ–°æŒ‘æˆ°</button>
        </div>
    </div>

    <script>
        // --- Game Configuration & Data ---

        const ASSET_TYPES = {
            STOCK: { name: "è‚¡ç¥¨", color: "blue", volatility: 0.15 },
            CRYPTO: { name: "åŠ å¯†è³‡ç”¢", color: "purple", volatility: 0.35 },
            COMMODITY: { name: "å¤§å®—å•†å“", color: "yellow", volatility: 0.1 },
            REIT: { name: "æˆ¿åœ°ç”¢", color: "orange", volatility: 0.05 },
            BOND: { name: "å‚µåˆ¸", color: "green", volatility: 0.02 }
        };

        // From PDF
        const ROLES = [
            { id: 'ai_expert', name: 'AI å°ˆå®¶', desc: 'ç§‘æŠ€è‚¡æ”¶ç›Š +20%', icon: 'ğŸ¤–', effect: (g) => g.roleBonus = { type: 'TECH', multi: 1.2 } },
            { id: 'crypto_guru', name: 'åŠ å¯†å‚³æ•™å£«', desc: 'åŠ å¯†è³‡ç”¢æ”¶ç›Š +20%', icon: 'â‚¿', effect: (g) => g.roleBonus = { type: 'CRYPTO', multi: 1.2 } },
            { id: 'estate_tycoon', name: 'æˆ¿ç”¢å¤§äº¨', desc: 'æˆ¿åœ°ç”¢ç§Ÿé‡‘æ”¶ç›Šé›™å€', icon: 'ğŸ¢', effect: (g) => g.roleBonus = { type: 'REIT', dividendMulti: 2 } },
            { id: 'insider', name: 'å…§ç·šäº¤æ˜“è€…', desc: 'æ¯å›åˆç²å¾— 2 æ¢å…§ç·šæ¶ˆæ¯', icon: 'ğŸ•µï¸', effect: (g) => g.extraIntel = true }
        ];

        const INITIAL_ASSETS = [
            { id: 'NVDA_AI', name: 'AI é‹ç®—æ ¸å¿ƒ', type: 'STOCK', subType: 'TECH', price: 100, dividend: 0.02 },
            { id: 'TSLA_EV', name: 'ç¶ èƒ½è¼‰å…·', type: 'STOCK', subType: 'TECH', price: 80, dividend: 0.01 },
            { id: 'BTC_COIN', name: 'æ¯”ç‰¹å¹£', type: 'CRYPTO', subType: 'CRYPTO', price: 200, dividend: 0 },
            { id: 'OIL_FUT', name: 'å…¨çƒåŸæ²¹', type: 'COMMODITY', subType: 'COMMODITY', price: 50, dividend: 0.03 },
            { id: 'NY_REIT', name: 'ç´ç´„å•†è¾¦', type: 'REIT', subType: 'REIT', price: 120, dividend: 0.05 },
            { id: 'US_BOND', name: 'ç¾åœ‹åœ‹å‚µ', type: 'BOND', subType: 'BOND', price: 100, dividend: 0.04 }
        ];

        // From PDF Events
        const EVENTS = [
            { text: "AI æ³¡æ²«ç ´è£‚ï¼ç§‘æŠ€è‚¡é‡æŒ«ã€‚", type: 'CRASH', target: 'TECH', impact: -0.3 },
            { text: "ä¸­æ±åœ°ç·£è¡çªå‡æº«ï¼ŒåŸæ²¹æš´æ¼²ã€‚", type: 'BOOM', target: 'COMMODITY', impact: 0.4 },
            { text: "ç¾è¯å„²å®£ä½ˆé™æ¯ï¼Œå…¨å¸‚å ´æ™®æ¼²ã€‚", type: 'BOOM', target: 'ALL', impact: 0.15 },
            { text: "å€å¡Šéˆç›£ç®¡æ³•è¦æ”¶ç·Šï¼ŒåŠ å¯†è²¨å¹£æš´è·Œã€‚", type: 'CRASH', target: 'CRYPTO', impact: -0.4 },
            { text: "ç¶ èƒ½é©å‘½ï¼æ”¿åºœè£œè²¼æ–°èƒ½æºç”¢æ¥­ã€‚", type: 'BOOM', target: 'TECH', impact: 0.25 },
            { text: "å…¨çƒç¶“æ¿Ÿè¡°é€€ï¼Œç¾é‡‘ç‚ºç‹ã€‚", type: 'CRASH', target: 'ALL', impact: -0.1 },
            { text: "æˆ¿å¸‚å¾©ç”¦ï¼Œç§Ÿé‡‘æ”¶ç›Šæå‡ã€‚", type: 'BOOM', target: 'REIT', impact: 0.15 },
            { text: "é»‘å®¢æ”»æ“Šäº¤æ˜“æ‰€ï¼ŒæŠ•è³‡äººææ…Œã€‚", type: 'CRASH', target: 'CRYPTO', impact: -0.2 }
        ];

        // --- Game Engine ---

        class CapitalEpoch {
            constructor() {
                this.round = 1;
                this.maxRounds = 10;
                this.cash = 100000;
                this.role = null;
                this.roleBonus = {}; 
                this.extraIntel = false;
                
                // Deep copy initial assets
                this.assets = JSON.parse(JSON.stringify(INITIAL_ASSETS));
                this.assets.forEach(a => {
                    a.history = [a.price];
                    a.trend = 0;
                });

                this.portfolio = {}; // { assetId: quantity }
                this.assets.forEach(a => this.portfolio[a.id] = 0);
                
                this.currentEvent = null;
                this.insiderInfo = null;
                this.log = [];

                this.chart = null;
            }

            init() {
                ui.renderRoleSelection();
                ui.initChart();
                this.startRound();
            }

            selectRole(roleId) {
                const role = ROLES.find(r => r.id === roleId);
                this.role = role;
                role.effect(this);
                ui.updateRoleDisplay(role);
                ui.hideModal('role-modal');
                this.updateUI();
            }

            startRound() {
                // Generate Info for this round
                this.generateInsiderInfo();
                ui.renderIntel(this.insiderInfo);
                ui.updateTicker("æ–°å›åˆé–‹å§‹ã€‚è«‹æ ¹æ“šå…§ç·šæƒ…å ±èª¿æ•´æ‚¨çš„æŠ•è³‡çµ„åˆ...");
            }

            generateInsiderInfo() {
                // Pick a random asset or sector to be affected next turn
                const targetIdx = Math.floor(Math.random() * this.assets.length);
                const asset = this.assets[targetIdx];
                
                // Determine direction (Simulate "True" insider info)
                // In this simplified version, info is 80% accurate
                const isPositive = Math.random() > 0.5;
                const accuracy = Math.random() > 0.2; // 20% chance info is wrong (trap)

                this.insiderInfo = {
                    target: asset.name,
                    targetId: asset.id,
                    type: asset.subType,
                    direction: isPositive ? 'ä¸Šæ¼²' : 'ä¸‹è·Œ',
                    isTrue: accuracy,
                    msg: `æƒ…å ±å“¡é€éœ²ï¼š${asset.name} ä¸‹ä¸€å­£è²¡å ±å¯èƒ½${isPositive ? 'å„ªæ–¼' : 'ä½æ–¼'}é æœŸã€‚`
                };

                // Insider role gets extra info
                if (this.extraIntel) {
                    const eventIdx = Math.floor(Math.random() * EVENTS.length);
                    this.insiderInfo.extraMsg = `å®è§€æ´©æ¼ï¼š${EVENTS[eventIdx].text.substring(0, 10)}... å¯èƒ½ç™¼ç”Ÿã€‚`;
                }
            }

            calculateNAV() {
                let assetValue = 0;
                for (let id in this.portfolio) {
                    const asset = this.assets.find(a => a.id === id);
                    assetValue += this.portfolio[id] * asset.price;
                }
                return this.cash + assetValue;
            }

            executeTrade(action) {
                const input = document.getElementById('trade-amount');
                const qty = parseInt(input.value);
                const assetId = ui.currentTradeAssetId;
                const asset = this.assets.find(a => a.id === assetId);

                if (qty <= 0) return;

                if (action === 'buy') {
                    const cost = qty * asset.price;
                    if (this.cash >= cost) {
                        this.cash -= cost;
                        this.portfolio[assetId] += qty;
                        ui.showNotification(`è²·å…¥ ${qty} ${asset.name}`, 'success');
                    } else {
                        ui.showNotification('ç¾é‡‘ä¸è¶³ï¼', 'error');
                        return;
                    }
                } else if (action === 'sell') {
                    if (this.portfolio[assetId] >= qty) {
                        const revenue = qty * asset.price;
                        this.cash += revenue;
                        this.portfolio[assetId] -= qty;
                        ui.showNotification(`è³£å‡º ${qty} ${asset.name}`, 'success');
                    } else {
                        ui.showNotification('æŒå€‰ä¸è¶³ï¼', 'error');
                        return;
                    }
                }

                ui.closeTradeModal();
                this.updateUI();
            }

            nextTurn() {
                // 1. Trigger Event
                const eventChance = Math.random();
                let activeEvent = null;
                
                if (eventChance > 0.3) { // 70% chance of event
                    const eventIdx = Math.floor(Math.random() * EVENTS.length);
                    activeEvent = EVENTS[eventIdx];
                    ui.updateTicker(`[é‡å¤§äº‹ä»¶] ${activeEvent.text}`);
                } else {
                    ui.updateTicker("å¸‚å ´å¹³ç©©é‹è¡Œä¸­...");
                }

                // 2. Update Prices
                this.assets.forEach(asset => {
                    let changePercent = 0;

                    // Base Volatility (Random walk)
                    const vol = ASSET_TYPES[asset.type].volatility;
                    const randomMove = (Math.random() * vol * 2) - vol; // -vol to +vol
                    changePercent += randomMove;

                    // Event Impact
                    if (activeEvent) {
                        if (activeEvent.target === 'ALL' || activeEvent.target === asset.subType) {
                            changePercent += activeEvent.impact;
                        }
                    }

                    // Insider Logic realization (Did the insider info come true?)
                    if (this.insiderInfo.targetId === asset.id) {
                        // If info was true, push price in that direction slightly more
                        if (this.insiderInfo.isTrue) {
                            changePercent += (this.insiderInfo.direction === 'ä¸Šæ¼²' ? 0.1 : -0.1);
                        } else {
                             // It was false info, market reacts opposite or randomly
                            changePercent += (this.insiderInfo.direction === 'ä¸Šæ¼²' ? -0.05 : 0.05);
                        }
                    }

                    // Apply Change
                    let oldPrice = asset.price;
                    asset.price = Math.max(1, Math.round(asset.price * (1 + changePercent)));
                    asset.history.push(asset.price);
                    asset.trend = ((asset.price - oldPrice) / oldPrice * 100).toFixed(1);

                    // 3. Dividends / Interest (Settlement)
                    if (this.portfolio[asset.id] > 0 && asset.dividend > 0) {
                        let divRate = asset.dividend;
                        // Role Bonus Logic
                        if (this.roleBonus.type === asset.subType) {
                            if (this.roleBonus.multi) divRate *= this.roleBonus.multi; // Price gain logic handled in NAV usually, but simplified here as cash yield for some roles
                            if (this.roleBonus.dividendMulti) divRate *= this.roleBonus.dividendMulti;
                        }

                        const income = Math.round(this.portfolio[asset.id] * asset.price * divRate);
                        if (income > 0) {
                            this.cash += income;
                            // ui.showNotification(`æ”¶åˆ° ${asset.name} è‚¡æ¯ $${income}`, 'info');
                        }
                    }
                });

                // 4. Check Game End
                if (this.round >= this.maxRounds) {
                    this.endGame();
                    return;
                }

                // 5. Next Round Setup
                this.round++;
                this.startRound(); // Generates new intel
                this.updateUI();
            }

            endGame() {
                const nav = this.calculateNAV();
                const profit = ((nav - 100000) / 100000 * 100).toFixed(1);
                document.getElementById('final-score').innerText = `$${nav.toLocaleString()}`;
                
                let title = "å¸‚å ´éŸ­èœ";
                if (nav > 250000) title = "è¯çˆ¾è¡—ä¹‹ç‹¼";
                else if (nav > 150000) title = "å„ªç§€ç¶“ç†äºº";
                else if (nav > 100000) title = "é¿éšªå°ˆå®¶";

                document.getElementById('final-rank').innerText = `${title} (å›å ±ç‡: ${profit}%)`;
                ui.showModal('end-modal');
            }

            updateUI() {
                document.getElementById('round-display').innerText = `${this.round} / ${this.maxRounds}`;
                document.getElementById('cash-display').innerText = `$${Math.floor(this.cash).toLocaleString()}`;
                document.getElementById('nav-display').innerText = `$${Math.floor(this.calculateNAV()).toLocaleString()}`;
                
                ui.renderMarket(this.assets);
                ui.renderPortfolio(this.portfolio, this.assets);
                ui.updateChart(this.assets);
            }
        }

        // --- UI Controller ---

        const ui = {
            currentTradeAssetId: null,

            renderRoleSelection: () => {
                const container = document.querySelector('#role-modal .grid');
                container.innerHTML = ROLES.map(role => `
                    <button onclick="game.selectRole('${role.id}')" class="bg-slate-700 hover:bg-slate-600 p-4 rounded-lg border border-slate-500 flex flex-col items-center gap-2 transition transform hover:scale-105">
                        <div class="text-4xl">${role.icon}</div>
                        <div class="font-bold text-blue-300">${role.name}</div>
                        <div class="text-xs text-slate-400 text-center">${role.desc}</div>
                    </button>
                `).join('');
            },

            renderIntel: (info) => {
                const panel = document.getElementById('intel-panel');
                let html = `<div class="p-2 border-l-2 border-blue-500 bg-blue-900/20 mb-2">
                    <span class="font-bold text-blue-300">å…§ç·šæ¶ˆæ¯:</span> ${info.msg}
                </div>`;
                
                if (info.extraMsg) {
                    html += `<div class="p-2 border-l-2 border-purple-500 bg-purple-900/20 mb-2">
                        <span class="font-bold text-purple-300">è·æ¥­ç‰¹æ¬Š:</span> ${info.extraMsg}
                    </div>`;
                }
                panel.innerHTML = html;
            },

            renderMarket: (assets) => {
                const grid = document.getElementById('market-grid');
                grid.innerHTML = assets.map(asset => {
                    const trendClass = asset.trend >= 0 ? 'trend-up' : 'trend-down';
                    const trendSign = asset.trend >= 0 ? '+' : '';
                    return `
                    <div onclick="ui.openTradeModal('${asset.id}')" class="asset-card glass-panel p-3 rounded cursor-pointer border border-slate-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-sm text-white">${asset.name}</div>
                                <div class="text-xs text-slate-500">${ASSET_TYPES[asset.type].name}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-white cyber-font">$${asset.price}</div>
                                <div class="text-xs ${trendClass}">${trendSign}${asset.trend}%</div>
                            </div>
                        </div>
                        <!-- Mini Bar for visual -->
                        <div class="w-full bg-slate-700 h-1 mt-2 rounded overflow-hidden">
                            <div class="h-full ${asset.trend >=0 ? 'bg-green-500' : 'bg-red-500'}" style="width: ${Math.min(Math.abs(asset.trend)*5, 100)}%"></div>
                        </div>
                    </div>
                    `;
                }).join('');
            },

            renderPortfolio: (portfolio, assets) => {
                const list = document.getElementById('portfolio-list');
                let html = '';
                let hasAssets = false;
                
                for (let [id, qty] of Object.entries(portfolio)) {
                    if (qty > 0) {
                        hasAssets = true;
                        const asset = assets.find(a => a.id === id);
                        const totalVal = qty * asset.price;
                        html += `
                        <div class="bg-slate-800 p-2 rounded border-l-2 border-blue-500 flex justify-between items-center">
                            <div>
                                <div class="text-sm font-bold text-white">${asset.name}</div>
                                <div class="text-xs text-slate-400">æŒæœ‰: ${qty}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-blue-300">$${totalVal.toLocaleString()}</div>
                            </div>
                        </div>
                        `;
                    }
                }

                if (!hasAssets) {
                    html = '<div class="text-center text-slate-500 text-sm mt-10">å°šæœªæŒæœ‰è³‡ç”¢</div>';
                }
                list.innerHTML = html;
            },

            updateRoleDisplay: (role) => {
                document.getElementById('role-name').innerText = role.name + " " + role.icon;
                document.getElementById('role-desc').innerText = role.desc;
            },

            updateTicker: (text) => {
                document.getElementById('news-ticker').innerText = text;
            },

            showHelp: () => {
                alert("éŠæˆ²ç›®æ¨™ï¼š\nåœ¨10å›åˆå…§åˆ©ç”¨å…§ç·šæ¶ˆæ¯èˆ‡è³‡ç”¢é…ç½®ï¼Œæœ€å¤§åŒ–æ‚¨çš„ç¸½è³‡ç”¢ã€‚\n\nç©æ³•ï¼š\n1. è§€å¯Ÿå·¦å´æƒ…å ±é¢æ¿çš„æ¶ˆæ¯ã€‚\n2. é»æ“Šå¸‚å ´è³‡ç”¢é€²è¡Œè²·è³£ã€‚\n3. çµæŸå›åˆï¼Œè§¸ç™¼åƒ¹æ ¼æ³¢å‹•ã€‚\n4. æ³¨æ„ï¼šæ¶ˆæ¯æœ‰æ™‚æ˜¯å‡çš„ï¼");
            },

            showNotification: (msg, type) => {
                // Simple alert replacement for this single-file scope, could be toast
                // console.log(`[${type}] ${msg}`);
                // A better ephemeral toast could go here, sticking to simplicity for now.
            },

            // Modal Logic
            openTradeModal: (assetId) => {
                ui.currentTradeAssetId = assetId;
                const asset = game.assets.find(a => a.id === assetId);
                const owned = game.portfolio[assetId];
                
                document.getElementById('trade-asset-name').innerText = asset.name;
                document.getElementById('trade-asset-price').innerText = `$${asset.price}`;
                document.getElementById('trade-owned').innerText = owned;
                document.getElementById('trade-max-buy').innerText = Math.floor(game.cash / asset.price);
                
                document.getElementById('trade-amount').value = 1;
                game.adjustTradeAmount(0); // update total

                ui.showModal('trade-modal');
            },

            closeTradeModal: () => {
                ui.hideModal('trade-modal');
                ui.currentTradeAssetId = null;
            },

            showModal: (id) => document.getElementById(id).classList.remove('hidden'),
            hideModal: (id) => document.getElementById(id).classList.add('hidden'),

            // Chart.js Integration
            initChart: () => {
                const ctx = document.getElementById('priceChart').getContext('2d');
                game.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['R0', 'R1'],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#94a3b8' } }
                        },
                        scales: {
                            y: { grid: { color: '#1e293b' }, ticks: { color: '#94a3b8' } },
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            },

            updateChart: (assets) => {
                if (!game.chart) return;
                
                const labels = assets[0].history.map((_, i) => `R${i}`);
                
                const datasets = assets.map(asset => ({
                    label: asset.name,
                    data: asset.history,
                    borderColor: ui.getColorCode(ASSET_TYPES[asset.type].color),
                    tension: 0.3,
                    pointRadius: 2,
                    borderWidth: 2
                }));

                game.chart.data.labels = labels;
                game.chart.data.datasets = datasets;
                game.chart.update();
            },

            getColorCode: (colorName) => {
                const map = {
                    'blue': '#3b82f6', 'purple': '#a855f7', 'yellow': '#eab308',
                    'orange': '#f97316', 'green': '#22c55e', 'red': '#ef4444'
                };
                return map[colorName] || '#fff';
            }
        };

        // Helper attached to game object
        game = new CapitalEpoch();
        game.adjustTradeAmount = (delta) => {
            const input = document.getElementById('trade-amount');
            let val = parseInt(input.value) + delta;
            if (val < 1) val = 1;
            input.value = val;

            if (ui.currentTradeAssetId) {
                const asset = game.assets.find(a => a.id === ui.currentTradeAssetId);
                const total = val * asset.price;
                document.getElementById('trade-total').innerText = `$${total.toLocaleString()}`;
                
                // Style check
                const totalEl = document.getElementById('trade-total');
                if (total > game.cash) totalEl.classList.replace('text-yellow-400', 'text-red-500');
                else totalEl.classList.replace('text-red-500', 'text-yellow-400');
            }
        };

        // Start
        window.onload = () => game.init();

    </script>
</body>
</html>