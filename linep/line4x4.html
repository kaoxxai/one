<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 貼圖裁切打包工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 flex flex-col items-center">

    <div class="max-w-4xl w-full mx-auto bg-white rounded-2xl shadow-xl overflow-hidden flex-grow">
        <!-- Header -->
        <div class="bg-[#06C755] p-6 text-white text-center">
            <h1 class="text-3xl font-bold mb-2">LINE 4X4 貼圖裁切打包工具</h1>
            <p class="opacity-90 mb-4">自動將 4x4 圖片裁切為 16 張符合規格的貼圖並打包下載</p>
            
            <!-- 使用說明 -->
            <div class="bg-white/20 rounded-lg p-4 text-left text-sm backdrop-blur-sm mx-auto max-w-2xl border border-white/30">
                <h3 class="font-bold mb-2 flex items-center gap-2 text-yellow-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    使用說明
                </h3>
                <ul class="list-decimal list-inside space-y-1 opacity-95 font-medium">
                    <li>準備一張包含 16 個貼圖的 4x4 網格圖片 (JPG 或 PNG)。</li>
                    <li>將圖片拖曳至下方虛線區域，或點擊選取檔案。</li>
                    <li>系統將自動裁切並調整大小至 LINE 貼圖規範 (370x320)。</li>
                    <li>確認預覽無誤後，點擊「下載貼圖壓縮檔」即可。</li>
                </ul>
            </div>
        </div>

        <div class="p-6 md:p-8 space-y-8">
            
            <!-- Upload Section -->
            <div id="dropZone" class="drop-zone border-4 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:border-gray-400 group relative">
                <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="space-y-4 pointer-events-none">
                    <svg class="w-16 h-16 mx-auto text-gray-400 group-hover:text-[#06C755] transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <div class="text-gray-600">
                        <span class="font-bold text-lg block">點擊上傳或拖曳圖片至此</span>
                        <span class="text-sm text-gray-400">支援 JPG, PNG 格式</span>
                    </div>
                </div>
            </div>

            <!-- Processing Status -->
            <div id="statusArea" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">預覽裁切結果</h3>
                    <button id="downloadBtn" class="bg-[#06C755] hover:bg-[#05b34c] text-white px-6 py-2 rounded-full font-bold shadow-lg transform transition hover:scale-105 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        下載貼圖壓縮檔 (ZIP)
                    </button>
                </div>
                
                <!-- Grid Preview -->
                <div id="previewGrid" class="grid grid-cols-4 gap-4 bg-gray-100 p-4 rounded-lg">
                    <!-- Preview images will be injected here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center text-gray-500 text-sm pb-4 w-full">
        <div class="mb-6 space-y-3">
            <h3 class="text-2xl font-bold text-[#06C755] drop-shadow-sm">謝謝使用</h3>
            
            <div class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-200">
                <span class="text-gray-400">累積訪客數：</span>
                <span id="visitorCount" class="font-mono font-bold text-gray-700 text-lg">Loading...</span>
            </div>
        </div>

        <a href="index.html" class="group inline-flex items-center gap-2 text-gray-600 hover:text-[#06C755] transition-all font-medium border-2 border-transparent hover:border-[#06C755] px-6 py-2 rounded-full hover:bg-white hover:shadow-md">
            <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>回主頁</a>
        <p class="text-xs text-gray-400 mt-6">© 2025 Ai Fintech Corp.</p>
    </footer>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const statusArea = document.getElementById('statusArea');
        const previewGrid = document.getElementById('previewGrid');
        const downloadBtn = document.getElementById('downloadBtn');

        // Simulate Visitor Count (Random number for demo)
        const randomVisitors = Math.floor(Math.random() * (98765 - 12345) + 12345);
        document.getElementById('visitorCount').innerText = randomVisitors.toLocaleString();

        let zip = new JSZip();
        let processedImages = [];

        // LINE Sticker Max Dimensions
        const MAX_WIDTH = 370;
        const MAX_HEIGHT = 320;

        // Drag and Drop Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFiles, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                processImage(file);
            }
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    sliceImage(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function sliceImage(img) {
            // Reset
            previewGrid.innerHTML = '';
            zip = new JSZip();
            processedImages = [];
            statusArea.classList.remove('hidden');

            const rows = 4;
            const cols = 4;
            const tileWidth = img.width / cols;
            const tileHeight = img.height / rows;

            let count = 1;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    // Create canvas for cropping
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Set canvas size to the tile size temporarily
                    canvas.width = tileWidth;
                    canvas.height = tileHeight;

                    // Draw the specific tile to canvas
                    ctx.drawImage(
                        img, 
                        c * tileWidth, r * tileHeight, // Source x, y
                        tileWidth, tileHeight,         // Source w, h
                        0, 0,                          // Dest x, y
                        tileWidth, tileHeight          // Dest w, h
                    );

                    // Now Resize to LINE Specs (Fit within 370x320)
                    const resizedCanvas = resizeToLineSpecs(canvas);
                    
                    // Convert to Blob and display/store
                    const dataUrl = resizedCanvas.toDataURL('image/png');
                    
                    // Add to UI
                    const div = document.createElement('div');
                    div.className = 'aspect-square bg-white rounded shadow-sm border border-gray-200 overflow-hidden flex items-center justify-center relative group';
                    
                    const imgEl = document.createElement('img');
                    imgEl.src = dataUrl;
                    imgEl.className = 'max-w-full max-h-full object-contain';
                    
                    const badge = document.createElement('span');
                    badge.className = 'absolute top-1 left-1 bg-black/50 text-white text-xs px-1.5 py-0.5 rounded';
                    badge.innerText = `#${count}`;

                    div.appendChild(imgEl);
                    div.appendChild(badge);
                    previewGrid.appendChild(div);

                    // Add to ZIP (remove data:image/png;base64, prefix)
                    const base64Data = dataUrl.split(',')[1];
                    // Format filename like 01.png, 02.png...
                    const fileName = `${count.toString().padStart(2, '0')}.png`;
                    zip.file(fileName, base64Data, {base64: true});

                    count++;
                }
            }
        }

        function resizeToLineSpecs(sourceCanvas) {
            let width = sourceCanvas.width;
            let height = sourceCanvas.height;

            // Calculate scale factor to fit within MAX_WIDTH x MAX_HEIGHT
            const scale = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);

            // If the image is smaller than max, we might not want to upscale it blurry, 
            // but for stickers, usually source is large. Let's strictly fit.
            // If we want to keep it crisp, we typically downscale.
            
            const newWidth = Math.round(width * scale);
            const newHeight = Math.round(height * scale);

            const destCanvas = document.createElement('canvas');
            destCanvas.width = newWidth;
            destCanvas.height = newHeight;
            const ctx = destCanvas.getContext('2d');
            
            // High quality scaling
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            ctx.drawImage(sourceCanvas, 0, 0, newWidth, newHeight);
            return destCanvas;
        }

        downloadBtn.addEventListener('click', function() {
            zip.generateAsync({type:"blob"})
            .then(function(content) {
                saveAs(content, "line_stickers_pack.zip");
            });
        });
    </script>
</body>
</html>