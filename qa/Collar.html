<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å‹å°æŒ‡æœŸè²¨ 2:1 ç›ˆè™§æ¯” (Collar) ç­–ç•¥ç”¢ç”Ÿå™¨</title>
    
    <style>
        body {
            font-family: "Microsoft JhengHei", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7fa;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .panel {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1, h2, h3 {
            color: #1a3b5d;
            border-bottom: 2px solid #e0e6ec;
            padding-bottom: 10px;
        }
        h1 {
            grid-column: 1 / -1;
            text-align: center;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        /* Style for Buy/Sell labels */
        .buy-label { color: #28a745; font-weight: 700; }
        .sell-label { color: #dc3545; font-weight: 700; }
        
        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }
        .input-group-static {
            font-size: 0.9rem;
            color: #666;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        .output-group {
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        .output-group .label {
            font-weight: 600;
            color: #1a3b5d;
        }
        .output-group .value {
            font-weight: 700;
            font-family: "Courier New", Courier, monospace;
        }
        .output-group .value.gain { color: #28a745; }
        .output-group .value.loss { color: #dc3545; }
        
        .suggestion-box {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
        }
        .suggestion-box h3 {
            margin-top: 0;
            color: #0056b3;
            border-bottom-color: #b3e0ff;
        }
        .suggestion-box p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #004085;
            line-height: 1.6;
        }
        .suggestion-box .target-value {
            font-size: 1.5rem;
            color: #007bff;
            font-weight: 700;
        }
        
        .chart-container {
            min-height: 450px;
        }
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="container">
        <h1>å°å‹å°æŒ‡æœŸè²¨ 2:1 ç›ˆè™§æ¯” (Collar) ç­–ç•¥ç”¢ç”Ÿå™¨</h1>

        <div class="panel">
            <h2>æ­¥é©Ÿ 1ï¼šå®šç¾©é¢¨éšª/å ±é…¬ç¯„åœ</h2>
            <div class="input-panel">
                <div class="input-group">
                    <label for="futuresPrice">æœŸè²¨é€²å ´é»æ•¸ (Fâ‚€) <span class="buy-label">(Long)</span></label>
                    <input type="number" id="futuresPrice" value="17500" step="1">
                </div>
                <div class="input-group">
                    <label for="distancePoints">é¢¨éšª/å ±é…¬ è·é›¢ (é»æ•¸)</label>
                    <input type="number" id="distancePoints" value="500" step="50">
                </div>
                <div class="input-group-static">
                    (æ‚¨é¡˜æ„æ‰¿å—çš„æœ€å¤§æå¤± / æœŸæœ›çš„æœ€å¤§æ”¶ç›Šï¼Œè·é›¢ Fâ‚€ çš„é»æ•¸)
                </div>
                 <div class="input-group">
                    <label for="contracts">å¥‘ç´„å£æ•¸ (N)</label>
                    <input type="number" id="contracts" value="1" step="1">
                </div>
            </div>
            
            <div class="suggestion-box">
                <h3>ğŸ’¡ è‡ªå‹•ç”Ÿæˆ 2:1 ç­–ç•¥</h3>
                <p>
                    1. å»ºè­° <span class="buy-label">è²·å…¥ (Buy)</span> Put å±¥ç´„åƒ¹ (Kâ‚š): <span id="sugPutStrike" class="target-value">17000</span><br>
                    2. å»ºè­° <span class="sell-label">è³£å‡º (Sell)</span> Call å±¥ç´„åƒ¹ (Ká´„): <span id="sugCallStrike" class="target-value">18000</span>
                </p>
                <p>
                    ç‚ºé”åˆ° 2:1 ç›ˆè™§æ¯”ï¼Œ<br>
                    æ‚¨å¿…é ˆå°‹æ‰¾ä¸€å€‹èƒ½**æ·¨æ”¶å…¥ (Credit)**<br>
                    <span id="targetNetPremium" class="target-value">166.67</span> é»çš„é¸æ“‡æ¬Šçµ„åˆã€‚
                </p>
                 <p style="font-size: 0.9rem; color: #555;">
                    (è«‹è‡³äº¤æ˜“è»Ÿé«”ï¼Œå°‹æ‰¾ Kâ‚š èˆ‡ Ká´„ çµ„åˆï¼Œä½¿ `Pá´„ - Pâ‚š` ç›¡å¯èƒ½æ¥è¿‘æ­¤ç›®æ¨™é»æ•¸)
                 </p>
            </div>

            <h2 style="margin-top: 20px;">æ­¥é©Ÿ 2ï¼šå¡«å…¥å¯¦éš›äº¤æ˜“æ¬Šåˆ©é‡‘</h2>
            <div class="input-group">
                <label for="putPremium">1. å¡«å…¥ <span class="buy-label">è²·å…¥ (Buy)</span> Put (Kâ‚š) çš„å¯¦éš›æ¬Šåˆ©é‡‘ (Pâ‚š)</label>
                <input type="number" id="putPremium" value="100">
                <span>+</span>
            <span>å¯¦éš›æœŸæ¬Šé»ä½ï¼š</span>
            <input type="number" placeholder="è¼¸å…¥é»æ•¸" min="0" step="0.1">
            </div>
            <div class="input-group">
                <label for="callPremium">2. å¡«å…¥ <span class="sell-label">è³£å‡º (Sell)</span> Call (Ká´„) çš„å¯¦éš›æ¬Šåˆ©é‡‘ (Pá´„)</label>
                <input type="number" id="callPremium" value="265">
                <span>+</span>
            <span>å¯¦éš›æœŸæ¬Šé»ä½ï¼š</span>
            <input type="number" placeholder="è¼¸å…¥é»æ•¸" min="0" step="0.1">
            </div>
        </div>

        <div class="panel">
            <h2>æœ€çµ‚ç­–ç•¥åˆ†æ (TWD) [ä¿è­‰é‡‘å¦è¨ˆ]</h2>
            <div class="output-panel">
                <div class="output-group">
                    <span class="label">å¯¦éš›æ·¨æ¬Šåˆ©é‡‘ (ç¸½å’Œ)</span>
                    <span class="value" id="netPremium">NT$0</span>
                </div>
                <div class="output-group">
                    <span class="label">å¯¦éš›æœ€å¤§æ”¶ç›Š (Max Gain)</span>
                    <span class="value gain" id="maxGain">NT$0</span>
                </div>
                <div class="output-group">
                    <span class="label">å¯¦éš›æœ€å¤§æå¤± (Max Loss)</span>
                    <span class="value loss" id="maxLoss">NT$0</span>
                </div>
                <div class="output-group">
                    <span class="label">**å¯¦éš›ç›ˆè™§æ¯” (R/R)**</span>
                    <span class="value" id="actualRR" style="font-size: 1.3rem; color: #007bff;">1.00</span>
                </div>
                <div class="output-group">
                    <span class="label">æç›Šå…©å¹³é» (é»æ•¸)</span>
                    <span class="value" id="breakEven">0</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // ç²å–æ‰€æœ‰è¼¸å…¥å…ƒä»¶
            const inputs = {
                futuresPrice: document.getElementById('futuresPrice'),
                distancePoints: document.getElementById('distancePoints'),
                contracts: document.getElementById('contracts'),
                putPremium: document.getElementById('putPremium'),
                callPremium: document.getElementById('callPremium'),
            };

            // ç²å–æ‰€æœ‰åˆ†æçµæœå…ƒä»¶
            const outputs = {
                netPremium: document.getElementById('netPremium'),
                maxGain: document.getElementById('maxGain'),
                maxLoss: document.getElementById('maxLoss'),
                actualRR: document.getElementById('actualRR'),
                breakEven: document.getElementById('breakEven'),
            };
            
            // ç²å–å»ºè­°å…ƒä»¶
            const suggestions = {
                putStrike: document.getElementById('sugPutStrike'),
                callStrike: document.getElementById('sugCallStrike'),
                targetNetPremium: document.getElementById('targetNetPremium'),
            };

            const ctx = document.getElementById('pnlChart').getContext('2d');
            let pnlChart = null; // åˆå§‹åŒ–åœ–è¡¨è®Šæ•¸

            // è¼”åŠ©å‡½å¼ï¼šæ ¼å¼åŒ–ç‚ºæ–°å°å¹£
            const currencyFormatter = new Intl.NumberFormat('zh-TW', {
                style: 'currency',
                currency: 'TWD',
                maximumFractionDigits: 0
            });

            function formatCurrency(value) {
                return currencyFormatter.format(value);
            }
            
            function formatPoints(value) {
                return value.toLocaleString('en-US', { maximumFractionDigits: 2 });
            }

            // åˆå§‹åŒ–åœ–è¡¨
            function initializeChart() {
                if (pnlChart) pnlChart.destroy(); 
                pnlChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [/* ... */] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'å°æŒ‡çµç®—é»æ•¸ (Sá´›)' } },
                            y: {
                                title: { display: true, text: 'ç¸½æç›Š (TWD)' },
                                ticks: { callback: (value) => formatCurrency(value) }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (items) => `çµç®—é»S: ${formatPoints(items[0].label)}`,
                                    label: (item) => `ç¸½æç›Š: ${formatCurrency(item.raw)}`
                                }
                            }
                        }
                    }
                });
            }

            // ä¸»è¦çš„è¨ˆç®—èˆ‡æ›´æ–°å‡½å¼
            function updateModel() {
                // 1. å¾è¼¸å…¥æ¬„ä½è®€å–æ•¸å€¼
                const F0 = parseFloat(inputs.futuresPrice.value) || 0; 
                const D = parseFloat(inputs.distancePoints.value) || 0; // è·é›¢
                const N = parseFloat(inputs.contracts.value) || 0;    
                const M = 50; // å¥‘ç´„ä¹˜æ•¸ (å›ºå®š)
                
                // 2. *** è‡ªå‹•ç”Ÿæˆç­–ç•¥ (æ­¥é©Ÿ 1) ***
                const Kp = F0 - D; // å»ºè­°çš„ Put å±¥ç´„åƒ¹
                const Kc = F0 + D; // å»ºè­°çš„ Call å±¥ç´„åƒ¹
                
                // NP_Target = (3*Fâ‚€ - 2*Kâ‚š - Ká´„) / 3
                const NpTarget = (3*F0 - 2*Kp - Kc) / 3;

                // 3. æ›´æ–°ã€Œç­–ç•¥å»ºè­°ã€é¢æ¿
                suggestions.putStrike.textContent = formatPoints(Kp);
                suggestions.callStrike.textContent = formatPoints(Kc);
                suggestions.targetNetPremium.textContent = formatPoints(NpTarget);

                // 4. è®€å–ã€Œå¯¦éš›ã€æ¬Šåˆ©é‡‘ (æ­¥é©Ÿ 2)
                const Pp = parseFloat(inputs.putPremium.value) || 0;    
                const Pc = parseFloat(inputs.callPremium.value) || 0;   

                // 5. è¨ˆç®—ã€Œå¯¦éš›ã€åˆ†æçµæœ
                // å¯¦éš›æ·¨æ¬Šåˆ©é‡‘ (é»æ•¸)
                const netPremiumPoints = Pc - Pp;
                // å¯¦éš›æ·¨æ¬Šåˆ©é‡‘ (TWD)
                const netPremiumTWD = netPremiumPoints * M * N ;

                // å¯¦éš›æœ€å¤§æ”¶ç›Š (TWD)
                // G = ((Ká´„ - Fâ‚€) + NP) * M * N
                const maxGainTWD = ((Kc - F0) + netPremiumPoints) * M * N;

                // é‚Šéš›æ¡ˆä¾‹ï¼šå¦‚æœ (F0-Kp) - NP ç‚ºè² ï¼ˆå³æ‚¨çš„æ·¨æ”¶å…¥å¤§æ–¼æ‚¨çš„é¢¨éšªç·©è¡ï¼‰
                // é€™æ„å‘³è‘—æ‚¨çš„ã€Œæœ€å¤§æå¤±ã€å¯¦éš›ä¸Šæ˜¯ã€Œæ­£çš„ã€ï¼ˆå³é–å®šåˆ©æ½¤ï¼‰
                // æ‚¨çš„æå¤±ã€Œçµ•å°å€¼ã€L_abs æ‡‰è©²æ˜¯ è² çš„æœ€å¤§æ”¶ç›Šï¼ˆå³é–å®šåˆ©æ½¤ï¼‰
                
                // å¯¦éš›æœ€å¤§æå¤± (TWD)
                // L_abs = ((Fâ‚€ - Kâ‚š) - NP) * M * N
                const maxLossBasePoints = (F0 - Kp) - netPremiumPoints;
                const maxLossAbsTWD = maxLossBasePoints * M * N;
                
                // æç›Šå…©å¹³é» (é»æ•¸) = Fâ‚€ - NP
                const breakEvenPoints = F0 - netPremiumPoints;
                
                // å¯¦éš›ç›ˆè™§æ¯”
                let actualRR = 0;
                if (maxLossAbsTWD > 0) { // æ­£å¸¸æƒ…æ³ï¼šæœ€å¤§æå¤±ç‚ºæ­£
                    actualRR = maxGainTWD / maxLossAbsTWD;
                } else if (maxGainTWD > 0 && maxLossAbsTWD <= 0) {
                    // ç‰¹æ®Šæƒ…æ³ï¼šæœ€å¤§æå¤±ç‚º 0 æˆ–è²  (å³é–å®šåˆ©æ½¤)
                    actualRR = Infinity; // é¢¨éšªç‚º 0 æˆ–è² 
                } else {
                    actualRR = 0; // å…¶ä»–æƒ…æ³ï¼ˆä¾‹å¦‚å…©è€…éƒ½ç‚ºè² ï¼‰
                }

                // 6. æ›´æ–°åˆ†æé¢æ¿
                outputs.netPremium.textContent = formatCurrency(netPremiumTWD);
                outputs.maxGain.textContent = formatCurrency(maxGainTWD);
                // é¡¯ç¤ºè² æ•¸çš„æœ€å¤§æå¤±
                outputs.maxLoss.textContent = formatCurrency(-maxLossAbsTWD);
                
                if (actualRR === Infinity) {
                    outputs.actualRR.textContent = "ç„¡é™ (é–å®šåˆ©æ½¤)";
                } else {
                    outputs.actualRR.textContent = `${formatPoints(actualRR)} : 1`;
                }

                outputs.breakEven.textContent = formatPoints(breakEvenPoints);
                
                // æ ¹æ“šæ·¨æˆæœ¬æ˜¯æ”¶å…¥é‚„æ˜¯æ”¯å‡ºï¼Œæ”¹è®Šé¡è‰²
                if (netPremiumTWD > 0) {
                    outputs.netPremium.className = "value gain";
                } else if (netPremiumTWD < 0) {
                    outputs.netPremium.className = "value loss";
                } else {
                    outputs.netPremium.className = "value";
                }

                // 7. ç”¢ç”Ÿåœ–è¡¨æ•¸æ“š
                const labels = [];
                const data = [];
                
                const rangeMin = Kp - (D * 0.5); // åœ–è¡¨ X è»¸ç¯„åœ
                const rangeMax = Kc + (D * 0.5);
                const step = (rangeMax - rangeMin) / 200; 

                for (let St = rangeMin; St <= rangeMax; St += step) {
                    labels.push(St); 

                    // è¨ˆç®—ä¸‰éƒ¨ä»½çš„æç›Š (TWD)
                    const futuresPnl = (St - F0) * M * N;
                    const putPnl = (Math.max(Kp - St, 0) - Pp) * M * N;
                    const callPnl = (-Math.max(St - Kc, 0) + Pc) * M * N;
                    
                    const totalPnl = futuresPnl + putPnl + callPnl;
                    data.push(totalPnl);
                }

                // 8. æ›´æ–°åœ–è¡¨
                pnlChart.data = {
                    labels: labels,
                    datasets: [{
                        label: 'ç¸½æç›Š (TWD)',
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                };
                pnlChart.update();
            }

            // 9. ç¶å®šäº‹ä»¶ç›£è½
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', updateModel);
            });

            // 10. é é¢è¼‰å…¥æ™‚ï¼Œç«‹å³åˆå§‹åŒ–åœ–è¡¨ä¸¦åŸ·è¡Œä¸€æ¬¡è¨ˆç®—
            initializeChart();
            updateModel();

        });
    </script>

</body>
</html>