<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½é‡åŒ–æŠ•è³‡çµ„åˆç”Ÿæˆå™¨ (V5)</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* --- ä¸»å®¹å™¨ --- */
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é é¦– --- */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 700; }
        .header p { margin: 10px 0 0; opacity: 0.9; font-size: 0.95rem; }

        /* --- å…§å®¹å€ --- */
        .content { padding: 30px; flex-grow: 1; }

        /* --- è¡¨å–®å…ƒä»¶ --- */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-control {
            width: 100%; padding: 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 1rem; box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-control:focus { border-color: #2a5298; outline: none; box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1); }
        .helper-text { font-size: 0.85rem; color: #888; margin-top: 5px; }

        /* --- æç¤ºå€å¡Š --- */
        .error-note {
            background: #e3f2fd; color: #0d47a1; padding: 12px;
            border-radius: 6px; font-size: 0.9rem; margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        /* --- æŒ‰éˆ•å€ --- */
        .btn-area { display: flex; gap: 15px; margin-top: 20px; }
        .btn {
            flex: 1; padding: 12px; border: none; border-radius: 6px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; color: white;
        }
        .btn-primary { background-color: #2a5298; }
        .btn-primary:hover { background-color: #1c3b75; transform: translateY(-1px); }
        .btn-copy { background-color: #28a745; }
        .btn-copy:hover { background-color: #218838; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        /* --- ç¨‹å¼ç¢¼è¼¸å‡º --- */
        textarea#code-output {
            width: 100%; height: 300px; background-color: #2d2d2d; color: #f8f8f2;
            font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9rem;
            padding: 15px; border-radius: 8px; border: none; resize: vertical;
            box-sizing: border-box; margin-top: 15px;
        }

        /* --- é å°¾ (New Added) --- */
        .footer {
            text-align: center;
            padding: 25px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        .footer p {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: #555;
            font-weight: 500;
        }
        .btn-home {
            ddisplay: inline-block;
            padding: 8px 16px;
            background-color: #007bff; /* è—è‰² */
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* ç¢ºä¿æ–‡å­—ä¸æ›è¡Œ */
        }
        .btn-home:hover {
            background-color: #5a6268;
        }

        @media (max-width: 600px) {
            .container { margin: 0; border-radius: 0; }
            .btn-area { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>AI é‡åŒ–æŠ•è³‡çµ„åˆç”Ÿæˆå™¨(V5)</h1>
        <p>Multi-Factor Quantitative Model(5) to Python Code</p>
    </div>

    <div class="content">
        
        <div class="info-section">
            <div class="info-title">é‡åŒ–æ¼”ç®—åŸç† (Quantitative Logic)</div>
            <div class="info-text">
                æœ¬ç³»çµ±åŸºæ–¼ <strong>APT (Arbitrage Pricing Theory)</strong> èˆ‡ <strong>ç¾ä»£æŠ•è³‡çµ„åˆç†è«– (MPT)</strong>ï¼Œè‡ªå‹•ç”Ÿæˆ Python ä»£ç¢¼åŸ·è¡Œä»¥ä¸‹åˆ†æï¼š
                <ul>
                    <li><strong>å› å­å›æ­¸ (Factor Regression)ï¼š</strong> åˆ©ç”¨ 6 å¤§å› å­ (Value, Growth, Momentum, Quality, LowVol, Size) æ‹†è§£å€‹è‚¡å ±é…¬ä¾†æºï¼Œè¨ˆç®—çœŸå¯¦ Betaã€‚</li>
                    <li><strong>é¢¨éšªæ¨¡å‹ (Risk Model)ï¼š</strong> é€éå› å­å…±è®Šç•°æ•¸çŸ©é™£ä¼°è¨ˆæŠ•è³‡çµ„åˆæ³¢å‹•ï¼Œæ¯”å–®ç´”ä½¿ç”¨æ­·å²å ±é…¬æ›´ç²¾æº–ã€‚</li>
                    <li><strong>æ•ˆç‡å‰ç·£å„ªåŒ– (Efficient Frontier)ï¼š</strong> ä½¿ç”¨ Scipy æ±‚è§£å™¨ï¼Œåœ¨ã€Œä¸åšç©º (Long-Only)ã€é™åˆ¶ä¸‹ï¼Œå°‹æ‰¾å¤æ™®æ¯”ç‡ (Sharpe Ratio) æœ€é«˜çš„æœ€ä½³æ¬Šé‡é…ç½®ã€‚</li>
                </ul>
            </div>
        </div>

        <div class="info-section" style="border-left-color: #28a745;">
            <div class="info-title">ä½¿ç”¨æ­¥é©Ÿ (Instructions)</div>
            <div class="info-text">
                <ol>
                    <li>åœ¨ä¸‹æ–¹è¼¸å…¥æ‚¨æƒ³åˆ†æçš„æŠ•è³‡çµ„åˆæˆåˆ†è‚¡ (ä¾‹å¦‚ï¼š0050 æˆåˆ†è‚¡æˆ–ç¾è‚¡ä»£ç¢¼)ã€‚</li>
                    <li>è¨­å®šå›æ¸¬èµ·å§‹æ—¥æœŸ (å»ºè­°è‡³å°‘ 3 å¹´ä»¥ç²å¾—æœ‰æ•ˆçµ±è¨ˆæ•¸æ“š)ã€‚</li>
                    <li>é»æ“Š <strong>ã€Œç”Ÿæˆ Python ç­–ç•¥ä»£ç¢¼ã€</strong>ã€‚</li>
                    <li>é»æ“Š <strong>ã€Œä¸€éµè¤‡è£½ã€</strong>ï¼Œå°‡ä»£ç¢¼è²¼å…¥ <a href="https://colab.research.google.com/" target="_blank">Google Colab</a> åŸ·è¡Œå³å¯ç²å¾—åœ–è¡¨å ±å‘Šã€‚</li>
                </ol>
            </div>
        </div>

        <form id="quant-form">
            <div class="form-group">
                <label class="form-label">æŠ•è³‡æ¨™çš„æ¸…å–® (Stock Tickers)</label>
                <input type="text" id="tickers" class="form-control" 
                       value="2330.TW, 2317.TW, 0050.TW, AAPL, TSLA" 
                       placeholder="è«‹è¼¸å…¥ä»£ç¢¼ï¼Œä»¥é€—è™Ÿåˆ†éš”">
                <div class="helper-text">æ”¯æ´æ··åˆè¼¸å…¥ï¼šå°è‚¡ (å¦‚ 2330.TW) èˆ‡ ç¾è‚¡ (å¦‚ NVDA)ã€‚éŒ¯èª¤ä»£ç¢¼æœƒè‡ªå‹•è¢«å¿½ç•¥ã€‚</div>
            </div>

            <div class="form-group">
                <label class="form-label">åˆ†æèµ·å§‹æ—¥æœŸ (Start Date)</label>
                <input type="date" id="start-date" class="form-control" value="2020-01-01">
            </div>

            <div class="btn-area">
                <button type="button" class="btn btn-primary" id="generate-btn">ç”Ÿæˆ Python ç­–ç•¥ä»£ç¢¼ ğŸš€</button>
            </div>
        </form>

        <textarea id="code-output" readonly placeholder="é»æ“Šä¸Šæ–¹æŒ‰éˆ•å¾Œï¼Œç”Ÿæˆçš„ Python ä»£ç¢¼å°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>
        
        <div class="btn-area">
            <button type="button" class="btn btn-copy" id="copy-btn" disabled>ä¸€éµè¤‡è£½ä»£ç¢¼ ğŸ“‹</button>
        </div>
    </div>

    <div class="footer">
                <p>æœ¬å·¥å…·ç”± AI Fintech Corp.ç ”ç™¼ï¼Œåƒ…ä¾›é‡åŒ–ç­–ç•¥é‹è¡Œå­¸ç¿’ä½¿ç”¨ã€‚</p>
        <p>æ‰€æœ‰åˆ†æçµæœå‡ä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ã€‚Â© 2025</p>
        <a href="https://www.aifinsys.com" class="btn-home" target="_blank">
                è¿”å›å®˜ç¶²
            </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const generateBtn = document.getElementById('generate-btn');
        const copyBtn = document.getElementById('copy-btn');
        const outputArea = document.getElementById('code-output');
        const tickerInput = document.getElementById('tickers');
        const startDateInput = document.getElementById('start-date');

        generateBtn.addEventListener('click', function() {
            const tickersRaw = tickerInput.value;
            const startDate = startDateInput.value;
            
            // ç°¡å–®çš„å­—ä¸²è™•ç†è½‰ List
            const tickerArray = tickersRaw.split(/[,ï¼Œ\n]+/).map(t => t.trim()).filter(t => t !== "");
            
            if (tickerArray.length === 0) {
                alert("è«‹è‡³å°‘è¼¸å…¥ä¸€æª”è‚¡ç¥¨ä»£ç¢¼ï¼");
                return;
            }

            const tickerString = JSON.stringify(tickerArray);

            // Python Code Template (åŸºæ–¼ Robust Ver 2.2 é‚è¼¯)
            const pythonCode = `
# ==============================================
# AI é‡åŒ–æŠ•è³‡çµ„åˆåˆ†æè…³æœ¬ (Ver 2.2 Robust)
# è‡ªå‹•ä¿®å¾©: è¼¸å…¥éŒ¯èª¤ã€æ•¸æ“šå°é½Šã€Pandas ç‰ˆæœ¬å…¼å®¹
# ==============================================

# 1. å®‰è£èˆ‡åŒ¯å…¥
!pip install yfinance statsmodels pandas numpy scipy matplotlib seaborn -q

import yfinance as yf
import pandas as pd
import numpy as np
import statsmodels.api as sm
from scipy.optimize import minimize
import matplotlib.pyplot as plt
import seaborn as sns

sns.set_theme(style="whitegrid")
plt.rcParams['font.sans-serif'] = ['DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 2. æ¥æ”¶ä½¿ç”¨è€…åƒæ•¸
user_tickers = ${tickerString}
start_date = '${startDate}'
end_date = pd.Timestamp.now().strftime('%Y-%m-%d')

print(f"ğŸš€ å•Ÿå‹•é‡åŒ–å¼•æ“... åŸå§‹è¼¸å…¥: {len(user_tickers)} æª”")
print(f"ğŸ“… åˆ†æå€é–“: {start_date} è‡³ {end_date}")

# å› å­ä»£ç† ETF (ç¾è‚¡ä»£ç¢¼)
factor_proxies = {
    'Value': 'IWD', 'Growth': 'IWF', 'Momentum': 'MTUM', 
    'Quality': 'QUAL', 'LowVol': 'USMV', 'Size': 'IWM'
}
factor_tickers = list(factor_proxies.values())
all_symbols = user_tickers + factor_tickers

# 3. æ•¸æ“šä¸‹è¼‰ (å®¹éŒ¯æ¨¡å¼)
print("ğŸ“¥ ä¸‹è¼‰å¸‚å ´æ•¸æ“šä¸­...")
try:
    data = yf.download(all_symbols, start=start_date, end=end_date, auto_adjust=True, progress=False)
    
    # è™•ç† yfinance å¤šå±¤ç´¢å¼•
    if isinstance(data.columns, pd.MultiIndex):
        try:
            data = data.xs('Close', level=0, axis=1)
        except:
            if 'Close' in data.columns.get_level_values(0):
                 data = data['Close']
except Exception as e:
    print(f"âŒ æ•¸æ“šä¸‹è¼‰ç•°å¸¸ (ä½†ä¸ä¸­æ–·): {e}")
    data = pd.DataFrame()

# 4. æ•¸æ“šæ¸…æ´— (Smart Cleaning)
if data.empty:
    raise ValueError("ç„¡æ³•ç²å–ä»»ä½•æ•¸æ“šï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚")

# (A) ç§»é™¤å…¨ç©ºæ¬„ä½ (è™•ç†è¼¸å…¥éŒ¯èª¤å¦‚ APPL)
data = data.dropna(axis=1, how='all')
valid_tickers = [t for t in user_tickers if t in data.columns]
print(f"âœ… æœ‰æ•ˆæ¨™çš„ ({len(valid_tickers)}): {valid_tickers}")

removed = set(user_tickers) - set(valid_tickers)
if removed:
    print(f"âš ï¸ å·²è‡ªå‹•å‰”é™¤ç„¡æ•ˆä»£ç¢¼: {removed}")

# (B) è¨ˆç®—æœˆå ±é…¬ (Pandas 2.0+ å…¼å®¹å¯«æ³•)
monthly_prices = data.resample('ME').last()
monthly_returns = monthly_prices.pct_change(fill_method=None)

# (C) æª¢æŸ¥å› å­å®Œæ•´æ€§
available_factors = [f for f in factor_tickers if f in monthly_returns.columns]
if len(available_factors) < len(factor_tickers):
    print("âš ï¸ è­¦å‘Š: éƒ¨åˆ†å› å­æ•¸æ“šç¼ºå¤±ï¼Œæ¨¡å‹å°‡é™ç´šåŸ·è¡Œã€‚")

# 5. å› å­å›æ­¸ (Pairwise Alignment æ ¸å¿ƒä¿®å¾©)
print("ğŸ§® åŸ·è¡Œå› å­å›æ­¸èˆ‡é¢¨éšªå»ºæ¨¡...")

factor_exposures = []
idio_variances = []
asset_expected_returns = []
final_valid_assets = [] 

# æº–å‚™å› å­çŸ©é™£
factor_data_raw = monthly_returns[available_factors]
factor_data_raw.columns = [k for k, v in factor_proxies.items() if v in available_factors]

mu_factors = factor_data_raw.mean()
cov_factors = factor_data_raw.cov()

for stock in valid_tickers:
    # é—œéµï¼šåªå–è©²è‚¡ç¥¨èˆ‡å› å­ã€ŒåŒæ™‚å­˜åœ¨ã€çš„æœˆä»½
    combined = pd.concat([monthly_returns[stock], factor_data_raw], axis=1).dropna()
    
    if len(combined) < 12:
        print(f"âš ï¸ è·³é {stock}: æœ‰æ•ˆæ•¸æ“šä¸è¶³ 12 å€‹æœˆ")
        continue
        
    y = combined.iloc[:, 0]
    X = sm.add_constant(combined.iloc[:, 1:])
    
    try:
        model = sm.OLS(y, X).fit()
        betas = model.params.drop('const')
        
        factor_exposures.append(betas)
        idio_variances.append(model.mse_resid)
        asset_expected_returns.append(np.dot(betas, mu_factors))
        final_valid_assets.append(stock)
    except:
        pass

if not final_valid_assets:
    raise ValueError("æ•¸æ“šä¸è¶³ï¼Œç„¡æ³•é€²è¡Œå„ªåŒ–åˆ†æã€‚")

df_exposures = pd.DataFrame(factor_exposures, index=final_valid_assets)
df_exposures.columns = factor_data_raw.columns

# 6. æŠ•è³‡çµ„åˆå„ªåŒ–
print(f"âš–ï¸ é‡å° {len(final_valid_assets)} æª”è³‡ç”¢åŸ·è¡Œå„ªåŒ–...")

B = df_exposures.values
D = np.diag(idio_variances)
Sigma_asset = B @ cov_factors.values @ B.T + D
Mu_asset = np.array(asset_expected_returns)

def neg_sharpe(weights, mu, sigma):
    port_ret = np.dot(weights, mu)
    port_vol = np.sqrt(np.dot(weights.T, np.dot(sigma, weights)))
    return -port_ret / port_vol if port_vol > 0 else 0

constraints = ({'type': 'eq', 'fun': lambda w: np.sum(w) - 1})
bounds = tuple((0.0, 1.0) for _ in range(len(final_valid_assets)))
init_guess = [1/len(final_valid_assets)] * len(final_valid_assets)

opt_res = minimize(neg_sharpe, init_guess, args=(Mu_asset, Sigma_asset),
                   method='SLSQP', bounds=bounds, constraints=constraints)
opt_weights = opt_res.x

# 7. è¦–è¦ºåŒ–å ±å‘Š
print("ğŸ“Š ç”Ÿæˆåœ–è¡¨...")
plt.figure(figsize=(18, 12))

# Heatmap
plt.subplot(2, 2, 1)
sns.heatmap(df_exposures, annot=True, cmap='coolwarm', center=0, fmt=".2f")
plt.title('Factor Exposures (Beta)', fontweight='bold')

# Weights
plt.subplot(2, 2, 2)
bars = plt.bar(final_valid_assets, opt_weights, color='#4c72b0', alpha=0.8)
plt.title('Optimized Weights (Long-Only)', fontweight='bold')
for bar in bars:
    yval = bar.get_height()
    if yval > 0.01: plt.text(bar.get_x() + bar.get_width()/2, yval, f'{yval*100:.1f}%', ha='center', va='bottom')

# Efficient Frontier
plt.subplot(2, 2, 3)
ws = np.random.random((1000, len(final_valid_assets)))
ws = (ws.T / ws.sum(axis=1)).T
rets = ws.dot(Mu_asset) * 12
vols = np.sqrt(np.diag(ws @ Sigma_asset @ ws.T)) * np.sqrt(12)
sharpes = rets / vols
plt.scatter(vols, rets, c=sharpes, cmap='viridis', alpha=0.3, s=10)
opt_ret_ann = np.dot(opt_weights, Mu_asset) * 12
opt_vol_ann = np.sqrt(np.dot(opt_weights.T, np.dot(Sigma_asset, opt_weights))) * np.sqrt(12)
plt.scatter(opt_vol_ann, opt_ret_ann, c='red', s=150, marker='*', label='Optimal')
plt.title('Efficient Frontier', fontweight='bold')
plt.legend()

# Backtest
plt.subplot(2, 2, 4)
stock_rets_clean = monthly_returns[final_valid_assets].fillna(0)
port_ret_series = stock_rets_clean.dot(opt_weights)
(1 + port_ret_series).cumprod().plot(color='red', label='Optimized Strategy')
plt.title('Historical Backtest', fontweight='bold')
plt.legend()

plt.tight_layout()
plt.show()

print(f"âœ… åˆ†æå®Œæˆï¼å»ºè­°æœ€å¤§æŒå€‰: {final_valid_assets[np.argmax(opt_weights)]} ({np.max(opt_weights)*100:.1f}%)")
            `.trim();

            outputArea.value = pythonCode;
            copyBtn.disabled = false;
            copyBtn.innerText = "ä¸€éµè¤‡è£½ä»£ç¢¼ ğŸ“‹";
            copyBtn.classList.remove('btn-secondary');
            copyBtn.classList.add('btn-copy');
        });

        // è¤‡è£½åŠŸèƒ½
        copyBtn.addEventListener('click', function() {
            outputArea.select();
            navigator.clipboard.writeText(outputArea.value).then(() => {
                copyBtn.innerText = "è¤‡è£½æˆåŠŸï¼âœ…";
                setTimeout(() => {
                    copyBtn.innerText = "ä¸€éµè¤‡è£½ä»£ç¢¼ ğŸ“‹";
                }, 2000);
            });
        });
    });
</script>

</body>
</html>