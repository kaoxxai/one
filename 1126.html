<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台指期模擬交易戰情室 - Pine 策略整合版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TradingView Lightweight Charts (鎖定 v4.1.1 版本以修復 API 相容性問題) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* 防止捲動，全螢幕應用 */
        }
        
        /* 台灣股市顏色慣例：紅漲綠跌 */
        .text-up { color: #ff333a; }
        .text-down { color: #00b050; }
        .bg-up { background-color: #ff333a; }
        .bg-down { background-color: #00b050; }
        .border-up { border-color: #ff333a; }
        .border-down { border-color: #00b050; }

        /* 按鈕特效 */
        .btn-trade:active { transform: scale(0.95); }
        
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .panel {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155;
            border-radius: 6px;
        }

        /* 閃爍動畫 - 用於成交 */
        @keyframes flash-red { 0% { background-color: rgba(255, 51, 58, 0.5); } 100% { background-color: transparent; } }
        @keyframes flash-green { 0% { background-color: rgba(0, 176, 80, 0.5); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-red 0.5s ease-out; }
        .flash-down { animation: flash-green 0.5s ease-out; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header: 儀表板資訊 -->
    <header class="h-16 flex items-center justify-between px-4 bg-slate-900 border-b border-slate-700 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-yellow-500"><i class="fa-solid fa-chart-line mr-2"></i>台指期模擬戰情室</div>
            <div class="text-sm text-slate-400">代號: <span class="text-white font-mono">TXF</span></div>
            <div id="price-display" class="text-2xl font-mono font-bold text-white transition-colors">18000</div>
        </div>

        <div class="flex items-center gap-6">
            <div class="text-center">
                <div class="text-xs text-slate-400">權益數 (TWD)</div>
                <div id="equity-display" class="text-xl font-mono font-bold text-white">1,000,000</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-slate-400">未平倉損益</div>
                <div id="pnl-display" class="text-xl font-mono font-bold text-slate-500">0</div>
            </div>
            <div class="text-center border-l border-slate-700 pl-6">
                <div class="text-xs text-slate-400">剩餘時間</div>
                <div id="timer-display" class="text-2xl font-mono font-bold text-yellow-400">00:00</div>
            </div>
        </div>

        <div>
            <button id="btn-settings" class="p-2 text-slate-400 hover:text-white"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <!-- Main Content Grid -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- 左側：圖表與策略區 -->
        <div class="flex-1 flex flex-col border-r border-slate-700 relative">
            <!-- 圖表容器 -->
            <div id="chart-container" class="flex-1 w-full bg-slate-900 relative">
                <!-- 浮水印 -->
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-slate-800 text-6xl font-bold pointer-events-none select-none opacity-20">
                    TXF 模擬
                </div>
            </div>
            
            <!-- Pine 策略狀態列 -->
            <div class="h-40 bg-slate-900 border-t border-slate-700 flex flex-col">
                <div class="px-3 py-1 bg-slate-800 text-xs font-bold text-blue-400 flex justify-between">
                    <span id="monitor-title"><i class="fa-solid fa-code mr-1"></i>Pine 策略監視器: 準備就緒</span>
                    <span id="strategy-status" class="text-slate-400">等待訊號...</span>
                </div>
                <div id="strategy-logs" class="flex-1 overflow-y-auto p-2 text-xs font-mono text-slate-300">
                    <!-- 策略日誌將輸出於此 -->
                    <div class="text-slate-500">// 系統初始化完成，請選擇策略並開始競賽...</div>
                </div>
            </div>
        </div>

        <!-- 右側：下單面板 -->
        <div class="w-80 bg-slate-800 flex flex-col shrink-0">
            
            <!-- 競賽控制 -->
            <div class="p-4 border-b border-slate-700 bg-slate-800">
                <label class="text-xs text-slate-400 block mb-1">競賽時間 (分鐘)</label>
                <div class="flex gap-2 mb-3">
                    <input type="number" id="input-duration" value="5" min="1" max="60" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-center">
                    <button id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm transition">
                        <i class="fa-solid fa-play mr-1"></i>開始
                    </button>
                    <button id="btn-reset" class="w-10 bg-slate-700 hover:bg-slate-600 text-white rounded transition" title="重置">
                        <i class="fa-solid fa-rotate-left"></i>
                    </button>
                </div>
                <div class="flex justify-between text-xs text-slate-500">
                    <span>保證金: <span class="text-slate-300">167,000</span></span>
                    <span>1點: <span class="text-slate-300">200 TWD</span></span>
                </div>
            </div>

            <!-- 下單按鈕區 -->
            <div class="p-4 flex-1 flex flex-col gap-4 overflow-y-auto">
                
                <!-- 手動下單 -->
                <div class="panel p-3">
                    <div class="text-xs text-slate-400 mb-2 font-bold">手動交易 (市價)</div>
                    <div class="flex gap-2 h-16">
                        <button id="btn-buy" class="btn-trade flex-1 bg-slate-700 border border-slate-600 hover:border-red-500 hover:bg-slate-700/80 rounded flex flex-col items-center justify-center transition group relative overflow-hidden" disabled>
                            <span class="text-red-500 font-bold text-lg">買進多單</span>
                            <span class="text-xs text-slate-400">Buy Market</span>
                            <div class="absolute inset-0 bg-red-500 opacity-0 group-hover:opacity-10 transition"></div>
                        </button>
                        <button id="btn-sell" class="btn-trade flex-1 bg-slate-700 border border-slate-600 hover:border-green-500 hover:bg-slate-700/80 rounded flex flex-col items-center justify-center transition group relative overflow-hidden" disabled>
                            <span class="text-green-500 font-bold text-lg">賣出空單</span>
                            <span class="text-xs text-slate-400">Sell Market</span>
                            <div class="absolute inset-0 bg-green-500 opacity-0 group-hover:opacity-10 transition"></div>
                        </button>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-xs text-slate-400">口數:</span>
                        <input type="number" id="input-qty" value="1" min="1" max="10" class="w-16 bg-slate-900 border border-slate-600 rounded text-center text-sm">
                    </div>
                </div>

                <!-- 策略控制 -->
                <div class="panel p-3">
                    <div class="mb-3">
                        <label class="text-xs text-slate-400 font-bold block mb-1">策略選擇</label>
                        <select id="strategy-selector" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white focus:border-blue-500 focus:outline-none">
                            <option value="ma_cross">均線交叉 (MA Cross)</option>
                            <option value="bb_reversion">布林通道 (B-Bands)</option>
                        </select>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-slate-400 font-bold">Auto-Trade (自動交易)</div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-strategy" class="sr-only peer" disabled>
                            <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="strategy-desc" class="text-[10px] text-slate-500 leading-tight">
                        邏輯: SMA(5) 上穿 SMA(20) 買進，下穿賣出。
                    </div>
                </div>

                <!-- 持倉資訊 -->
                <div class="panel p-3 flex-1 flex flex-col">
                    <div class="text-xs text-slate-400 mb-2 font-bold flex justify-between items-center">
                        <span>目前持倉</span>
                        <button id="btn-flatten" class="px-2 py-0.5 bg-slate-600 hover:bg-slate-500 text-[10px] rounded text-white" disabled>全部平倉</button>
                    </div>
                    
                    <div id="position-info" class="flex-1 flex flex-col items-center justify-center text-slate-500 gap-2">
                        <i class="fa-solid fa-box-open text-3xl opacity-30"></i>
                        <span class="text-sm">無持倉</span>
                    </div>
                </div>

                <!-- 交易紀錄 (簡化版) -->
                <div class="panel p-3 h-32 overflow-hidden flex flex-col">
                    <div class="text-xs text-slate-400 mb-1 font-bold">最新成交</div>
                    <div id="trade-log" class="flex-1 overflow-y-auto text-xs font-mono space-y-1">
                        <!-- Logs -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Footer: 頁尾教學聲明 -->
    <footer class="bg-slate-900 border-t border-slate-700 p-2 flex justify-between items-center text-xs text-slate-500 shrink-0 select-none">
        <div>
            <i class="fa-solid fa-circle-info mr-1"></i>
            2025 © Ai FinTecg Corp. 本系統僅供教學使用。
        </div>
        <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-1 rounded transition flex items-center gap-1">
            <i class="fa-solid fa-house"></i> <a href="index.html" class="home-btn">回主頁</a>
        </button>
    </footer>

    <!-- 結算視窗 (Modal) -->
    <div id="settle-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-lg p-8 max-w-md w-full text-center shadow-2xl transform scale-100 transition-transform">
            <div class="text-4xl mb-4 text-yellow-400"><i class="fa-solid fa-trophy"></i></div>
            <h2 class="text-2xl font-bold text-white mb-2">回合結算</h2>
            <p class="text-slate-400 mb-6 text-sm">本次交易競賽已結束，所有部位已自動平倉。</p>
            
            <div class="bg-slate-900 rounded p-4 mb-4 grid grid-cols-2 gap-4">
                <div class="text-right text-slate-400 text-sm">初始權益:</div>
                <div class="text-left font-mono text-white">1,000,000</div>
                
                <div class="text-right text-slate-400 text-sm">最終權益:</div>
                <div id="final-equity" class="text-left font-mono font-bold text-white">--</div>
                
                <div class="text-right text-slate-400 text-sm">總損益:</div>
                <div id="final-pnl" class="text-left font-mono font-bold text-white">--</div>
                
                <div class="text-right text-slate-400 text-sm">報酬率:</div>
                <div id="final-roi" class="text-left font-mono font-bold text-white">--</div>
            </div>
            
            <div class="text-xs text-slate-500 mb-6">* 已扣除最終平倉之手續費與交易稅</div>

            <button id="btn-modal-close" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold w-full transition">
                確定
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. 配置與常數
        // ==========================================
        const CONFIG = {
            initialCapital: 1000000,
            pointValue: 200,      // 台指期 1點 200元
            feePerOrder: 50,      // 模擬手續費
            taxRate: 0.00002,     // 模擬交易稅
            startPrice: 18000,
            tickInterval: 500,    // 模擬行情更新速度 (ms)
            bbPeriod: 20,         // 布林通道週期
            bbMultiplier: 2,      // 布林通道標準差倍數
            colors: {
                up: '#ff333a',    // 台股紅漲
                down: '#00b050',  // 台股綠跌
                textUp: '#ff333a',
                textDown: '#00b050',
                candleUp: '#ff333a',
                candleDown: '#00b050',
                wickUp: '#ff333a',
                wickDown: '#00b050',
                bbLine: 'rgba(192, 132, 252, 0.6)' // 紫色布林線
            }
        };

        // ==========================================
        // 2. 應用程式狀態 (State)
        // ==========================================
        const state = {
            isRunning: false,
            timeRemaining: 0, // 秒
            equity: CONFIG.initialCapital,
            position: 0, // 正數多單，負數空單
            avgPrice: 0,
            currentPrice: CONFIG.startPrice,
            candles: [], // K線數據
            currentCandle: null,
            lastTickTime: 0,
            strategyActive: false,
            currentStrategy: 'ma_cross' // 'ma_cross' or 'bb_reversion'
        };

        let timerInterval = null;
        let tickInterval = null;
        // Chart Series
        let chart, candleSeries, volumeSeries;
        let ma5Series, ma20Series;
        let bbUpperSeries, bbLowerSeries;

        // ==========================================
        // 3. 圖表初始化 (Using Lightweight Charts)
        // ==========================================
        function initChart() {
            const chartOptions = {
                layout: {
                    background: { type: 'solid', color: '#0f172a' },
                    textColor: '#94a3b8',
                },
                grid: {
                    vertLines: { color: '#1e293b' },
                    horzLines: { color: '#1e293b' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: true,
                },
            };

            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, chartOptions);

            // K線圖層 (保持預設，顯示標籤)
            candleSeries = chart.addCandlestickSeries({
                upColor: CONFIG.colors.candleUp,
                downColor: CONFIG.colors.candleDown,
                borderUpColor: CONFIG.colors.wickUp,
                borderDownColor: CONFIG.colors.wickDown,
                wickUpColor: CONFIG.colors.wickUp,
                wickDownColor: CONFIG.colors.wickDown,
            });

            // 布林通道圖層 (Upper/Lower) - 徹底移除 title 以避免顯示標籤，並設定所有隱藏屬性
            bbUpperSeries = chart.addLineSeries({ 
                color: CONFIG.colors.bbLine, 
                lineWidth: 1, 
                lineStyle: LightweightCharts.LineStyle.Solid,
                // title: 'BB Upper', // 移除 title
                lastValueVisible: false,
                priceLineVisible: false,
                crosshairMarkerVisible: false 
            });
            bbLowerSeries = chart.addLineSeries({ 
                color: CONFIG.colors.bbLine, 
                lineWidth: 1, 
                lineStyle: LightweightCharts.LineStyle.Solid,
                // title: 'BB Lower', // 移除 title
                lastValueVisible: false,
                priceLineVisible: false,
                crosshairMarkerVisible: false
            });

            // 均線圖層 - 徹底移除 title 以避免顯示標籤，並設定所有隱藏屬性
            ma5Series = chart.addLineSeries({ 
                color: '#fbbf24', 
                lineWidth: 2, 
                // title: 'SMA 5', // 移除 title
                lastValueVisible: false,
                priceLineVisible: false,
                crosshairMarkerVisible: false
            }); 
            ma20Series = chart.addLineSeries({ 
                color: '#3b82f6', 
                lineWidth: 2, 
                // title: 'SMA 20', // 移除 title
                lastValueVisible: false,
                priceLineVisible: false,
                crosshairMarkerVisible: false
            }); 

            // 成交量圖層
            volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: { type: 'volume' },
                priceScaleId: '', 
            });
            volumeSeries.priceScale().applyOptions({
                scaleMargins: { top: 0.8, bottom: 0 },
            });

            // 響應式調整
            window.addEventListener('resize', () => {
                chart.resize(container.clientWidth, container.clientHeight);
            });
        }

        // ==========================================
        // 4. 數學計算 (SMA & StdDev)
        // ==========================================
        function calculateSMA(data, period) {
            if (data.length < period) return null;
            const slice = data.slice(-period);
            const sum = slice.reduce((acc, val) => acc + val.close, 0);
            return sum / period;
        }

        function calculateStdDev(data, period, sma) {
            if (data.length < period || sma === null) return null;
            const slice = data.slice(-period);
            const sumSqDiff = slice.reduce((acc, val) => {
                const diff = val.close - sma;
                return acc + (diff * diff);
            }, 0);
            return Math.sqrt(sumSqDiff / period);
        }

        // ==========================================
        // 5. 模擬行情引擎
        // ==========================================
        function generateTick(timeOverride) {
            // 修改: 允許傳入時間覆蓋，用於預載數據
            const now = timeOverride || Math.floor(Date.now() / 1000);
            
            // 隨機漫步
            const volatility = 6; // 稍微增加波動讓 BB 更有感
            const change = (Math.random() - 0.5) * volatility * 2;
            let price = state.currentPrice + change;
            price = Math.round(price * 100) / 100; 
            
            state.currentPrice = price;

            // K線聚合 (1分鐘K線 => 模擬用 5秒)
            const timeResolution = 5; 
            const candleTime = Math.floor(now / timeResolution) * timeResolution;

            if (!state.currentCandle || state.currentCandle.time !== candleTime) {
                // 修正: 當進入新 K 線時，將舊 K 線存入歷史陣列
                if (state.currentCandle) {
                    state.candles.push(state.currentCandle);
                    // 保持歷史數據長度，避免過長 (可選)
                    if (state.candles.length > 200) state.candles.shift();
                }

                // New Candle
                state.currentCandle = {
                    time: candleTime,
                    open: price,
                    high: price,
                    low: price,
                    close: price,
                    volume: Math.floor(Math.random() * 10)
                };
            } else {
                // Update Candle
                state.currentCandle.high = Math.max(state.currentCandle.high, price);
                state.currentCandle.low = Math.min(state.currentCandle.low, price);
                state.currentCandle.close = price;
                state.currentCandle.volume += Math.floor(Math.random() * 5);
            }

            // 更新圖表
            candleSeries.update(state.currentCandle);
            volumeSeries.update({
                time: state.currentCandle.time,
                value: state.currentCandle.volume,
                color: state.currentCandle.close >= state.currentCandle.open ? 'rgba(255, 51, 58, 0.3)' : 'rgba(0, 176, 80, 0.3)'
            });

            updatePriceUI(price, change);
            updatePnL();
            updateIndicators();
        }

        function updatePriceUI(price, change) {
            const el = document.getElementById('price-display');
            el.innerText = price.toFixed(0);
            el.className = `text-2xl font-mono font-bold transition-colors ${change >= 0 ? 'text-up flash-up' : 'text-down flash-down'}`;
            setTimeout(() => {
                 el.className = `text-2xl font-mono font-bold transition-colors ${change >= 0 ? 'text-up' : 'text-down'}`;
            }, 500);
        }

        // ==========================================
        // 6. 指標與策略核心
        // ==========================================
        function updateIndicators() {
            // 構建臨時歷史數據用於計算
            const tempHistory = [...state.candles];
            if(state.currentCandle) tempHistory.push(state.currentCandle);

            // 計算 SMA (MA5, MA20)
            const sma5 = calculateSMA(tempHistory, 5);
            const sma20 = calculateSMA(tempHistory, 20); // 也是 BB Middle Band

            // 計算 Bollinger Bands
            let bbUpper = null;
            let bbLower = null;
            if (sma20 !== null) {
                const stdDev = calculateStdDev(tempHistory, CONFIG.bbPeriod, sma20);
                if (stdDev !== null) {
                    bbUpper = sma20 + (stdDev * CONFIG.bbMultiplier);
                    bbLower = sma20 - (stdDev * CONFIG.bbMultiplier);
                }
            }

            // 更新線圖
            if (sma5) ma5Series.update({ time: state.currentCandle.time, value: sma5 });
            if (sma20) ma20Series.update({ time: state.currentCandle.time, value: sma20 });
            if (bbUpper) bbUpperSeries.update({ time: state.currentCandle.time, value: bbUpper });
            if (bbLower) bbLowerSeries.update({ time: state.currentCandle.time, value: bbLower });

            // 策略執行
            if (state.strategyActive && state.isRunning) {
                if (state.currentStrategy === 'ma_cross') {
                    if (sma5 && sma20) checkMACrossStrategy(sma5, sma20);
                } else if (state.currentStrategy === 'bb_reversion') {
                    if (bbUpper && bbLower) checkBBandsStrategy(state.currentCandle.close, bbUpper, bbLower);
                }
            }
        }

        let lastSignal = null; // 'BUY' or 'SELL'

        // 策略 A: 均線交叉
        function checkMACrossStrategy(shortMa, longMa) {
            if (shortMa > longMa && lastSignal !== 'BUY') {
                triggerSignal('BUY', 'MA黃金交叉', '#2196F3', 'arrowUp', 'belowBar');
            } else if (shortMa < longMa && lastSignal !== 'SELL') {
                triggerSignal('SELL', 'MA死亡交叉', '#e91e63', 'arrowDown', 'aboveBar');
            }
        }

        // 策略 B: 布林通道均值回歸 (逆勢)
        function checkBBandsStrategy(price, upper, lower) {
            // 價格跌破下軌 -> 視為超賣 -> 買進 (回歸中軸)
            if (price < lower && lastSignal !== 'BUY') {
                triggerSignal('BUY', '跌破BB下軌(超賣)', '#9c27b0', 'arrowUp', 'belowBar');
            } 
            // 價格突破上軌 -> 視為超買 -> 賣出 (回歸中軸)
            else if (price > upper && lastSignal !== 'SELL') {
                triggerSignal('SELL', '突破BB上軌(超買)', '#9c27b0', 'arrowDown', 'aboveBar');
            }
        }

        function triggerSignal(type, reason, color, shape, position) {
            lastSignal = type;
            logStrategy(`Signal: ${type} - ${reason} @ ${state.currentPrice}`);

            // 標記圖表
            candleSeries.setMarkers([
                {
                    time: state.currentCandle.time,
                    position: position,
                    color: color,
                    shape: shape,
                    text: type === 'BUY' ? 'L' : 'S',
                }
            ]);

            // 自動下單執行
            if (type === 'BUY') {
                if (state.position < 0) executeOrder('buy', Math.abs(state.position)); // 平空
                if (state.position === 0) executeOrder('buy', 1); // 建立多單
            } else {
                if (state.position > 0) executeOrder('sell', Math.abs(state.position)); // 平多
                if (state.position === 0) executeOrder('sell', 1); // 建立空單
            }
        }

        function logStrategy(msg) {
            const logs = document.getElementById('strategy-logs');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="text-slate-500">[${time}]</span> ${msg}`;
            logs.prepend(div);
        }

        // ==========================================
        // 7. 交易執行 (Order Logic)
        // ==========================================
        function executeOrder(side, qty) {
            // 修正：允許平倉操作即使 isRunning 為 false (用於 endGame 強制平倉)
            // 但如果不是 isRunning 且不是平倉，則不執行
            // 這裡為了簡單，我們假設 endGame 呼叫的 flattenAll 是安全的
            // if (!state.isRunning) return; 

            qty = parseInt(qty);
            const price = state.currentPrice;
            
            // 成本計算 (手續費 + 稅)
            const cost = qty * CONFIG.feePerOrder + (price * CONFIG.pointValue * qty * CONFIG.taxRate);
            state.equity -= cost;

            if (side === 'buy') {
                if (state.position < 0) { 
                    const coverQty = Math.min(qty, Math.abs(state.position));
                    const realizedPnL = (state.avgPrice - price) * coverQty * CONFIG.pointValue;
                    state.equity += realizedPnL;
                    state.position += coverQty;
                    qty -= coverQty;
                    logTrade(`平空單 ${coverQty} 口 @ ${price}, 損益: ${realizedPnL.toFixed(0)}`);
                }
                if (qty > 0) {
                    const newTotalValue = (state.position * state.avgPrice) + (qty * price);
                    state.position += qty;
                    state.avgPrice = newTotalValue / state.position;
                    logTrade(`買進多單 ${qty} 口 @ ${price}`);
                }
            } else { 
                if (state.position > 0) {
                    const coverQty = Math.min(qty, state.position);
                    const realizedPnL = (price - state.avgPrice) * coverQty * CONFIG.pointValue;
                    state.equity += realizedPnL;
                    state.position -= coverQty;
                    qty -= coverQty;
                    logTrade(`平多單 ${coverQty} 口 @ ${price}, 損益: ${realizedPnL.toFixed(0)}`);
                }
                if (qty > 0) {
                    const currentAbsPos = Math.abs(state.position);
                    const newTotalValue = (currentAbsPos * state.avgPrice) + (qty * price);
                    state.position -= qty;
                    state.avgPrice = newTotalValue / Math.abs(state.position);
                    logTrade(`賣出空單 ${qty} 口 @ ${price}`);
                }
            }
            updatePositionUI();
        }

        function updatePnL() {
            let unrealizedPnL = 0;
            if (state.position !== 0) {
                const diff = state.currentPrice - state.avgPrice;
                unrealizedPnL = diff * state.position * CONFIG.pointValue;
            }
            const elPnL = document.getElementById('pnl-display');
            elPnL.innerText = unrealizedPnL.toLocaleString('en-US', { maximumFractionDigits: 0 });
            elPnL.className = `text-xl font-mono font-bold ${unrealizedPnL > 0 ? 'text-up' : (unrealizedPnL < 0 ? 'text-down' : 'text-slate-500')}`;
            
            // 更新 Header Equity
            const totalEquity = state.equity + unrealizedPnL;
            document.getElementById('equity-display').innerText = totalEquity.toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function updatePositionUI() {
            const container = document.getElementById('position-info');
            const btnFlatten = document.getElementById('btn-flatten');

            if (state.position === 0) {
                container.innerHTML = `<i class="fa-solid fa-box-open text-3xl opacity-30"></i><span class="text-sm">無持倉</span>`;
                container.className = "flex-1 flex flex-col items-center justify-center text-slate-500 gap-2";
                btnFlatten.disabled = true;
            } else {
                const sideText = state.position > 0 ? "多單 (Long)" : "空單 (Short)";
                const sideColor = state.position > 0 ? "text-up" : "text-down";
                const borderClass = state.position > 0 ? "border-l-4 border-up" : "border-l-4 border-down";
                
                container.innerHTML = `
                    <div class="w-full h-full bg-slate-900 rounded p-2 flex flex-col justify-center ${borderClass}">
                        <div class="text-xs text-slate-400">方向 / 口數</div>
                        <div class="text-lg font-bold ${sideColor}">${sideText} <span class="text-white ml-1">${Math.abs(state.position)}</span></div>
                        <div class="text-xs text-slate-400 mt-1">均價</div>
                        <div class="text-white font-mono">${state.avgPrice.toFixed(0)}</div>
                    </div>
                `;
                container.className = "flex-1 w-full";
                btnFlatten.disabled = false;
            }
        }

        function logTrade(msg) {
            const logContainer = document.getElementById('trade-log');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.className = "border-b border-slate-700 pb-1 last:border-0";
            div.innerHTML = `<span class="text-slate-500 text-[10px]">${time}</span> <span class="text-slate-200">${msg}</span>`;
            logContainer.prepend(div);
        }

        function flattenAll() {
            if (state.position === 0) return;
            const side = state.position > 0 ? 'sell' : 'buy';
            executeOrder(side, Math.abs(state.position));
        }

        // ==========================================
        // 8. 遊戲流程
        // ==========================================
        function startGame() {
            const minutes = parseInt(document.getElementById('input-duration').value);
            state.timeRemaining = minutes * 60;
            state.isRunning = true;
            state.candles = []; 
            state.currentCandle = null; // 重置當前 K 線
            state.equity = CONFIG.initialCapital;
            state.position = 0;
            state.currentPrice = CONFIG.startPrice;
            lastSignal = null;
            
            candleSeries.setData([]);
            volumeSeries.setData([]);
            ma5Series.setData([]);
            ma20Series.setData([]);
            bbUpperSeries.setData([]);
            bbLowerSeries.setData([]);
            
            document.getElementById('trade-log').innerHTML = '';
            document.getElementById('strategy-logs').innerHTML = '';
            updatePositionUI();
            updatePnL();
            toggleControls(true);

            if (tickInterval) clearInterval(tickInterval);
            if (timerInterval) clearInterval(timerInterval);

            prefillData(60); // 預載 60 筆數據 (確保有足夠歷史計算 MA20)

            tickInterval = setInterval(() => generateTick(), CONFIG.tickInterval); // 使用箭頭函數避免傳參錯誤
            timerInterval = setInterval(updateTimer, 1000);
        }

        function prefillData(count) {
            const now = Math.floor(Date.now() / 1000);
            const timeResolution = 5;
            
            // 修正: 模擬時間推進，由過去推向現在
            // 從 (now - count * 5秒) 開始生成
            for(let i = 0; i < count; i++) {
                // 計算過去的時間戳記
                const pastTime = now - ((count - i) * timeResolution);
                // 每個時間點生成幾次 tick 以形成 High/Low 變化
                for(let tick = 0; tick < 3; tick++) {
                    generateTick(pastTime);
                }
            }
        }

        function updateTimer() {
            state.timeRemaining--;
            const m = Math.floor(state.timeRemaining / 60).toString().padStart(2, '0');
            const s = (state.timeRemaining % 60).toString().padStart(2, '0');
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.innerText = `${m}:${s}`;
            
            timerDisplay.className = `text-2xl font-mono font-bold ${state.timeRemaining <= 10 ? 'text-red-500' : 'text-yellow-400'}`;

            if (state.timeRemaining <= 0) endGame();
        }

        function endGame() {
            state.isRunning = false;
            clearInterval(tickInterval);
            clearInterval(timerInterval);
            
            // 強制平倉：這裡會產生最後一筆手續費與交易稅
            flattenAll(); 
            
            // 修正：在平倉後立即更新一次 PnL 與 Equity 顯示，
            // 確保「Header 顯示的金額」與「Modal 顯示的金額」一致
            updatePnL(); 

            toggleControls(false);
            showSettlement();
        }

        function toggleControls(enable) {
            document.getElementById('btn-buy').disabled = !enable;
            document.getElementById('btn-sell').disabled = !enable;
            document.getElementById('btn-flatten').disabled = !enable || state.position === 0;
            document.getElementById('toggle-strategy').disabled = !enable;
            document.getElementById('strategy-selector').disabled = !enable;
            document.getElementById('btn-start').disabled = enable;
            
            const opacity = enable ? 'opacity-100' : 'opacity-50';
            document.getElementById('btn-buy').className = document.getElementById('btn-buy').className.replace(/opacity-\d+/g, '') + ` ${opacity}`;
            document.getElementById('btn-sell').className = document.getElementById('btn-sell').className.replace(/opacity-\d+/g, '') + ` ${opacity}`;
        }

        function showSettlement() {
            // 使用 Math.round 確保顯示整數，避免浮點數誤差
            const finalEquity = Math.round(state.equity);
            const pnl = Math.round(finalEquity - CONFIG.initialCapital);
            const roi = (pnl / CONFIG.initialCapital) * 100;
            
            document.getElementById('final-equity').innerText = finalEquity.toLocaleString();
            
            const elPnl = document.getElementById('final-pnl');
            elPnl.innerText = pnl.toLocaleString();
            elPnl.className = `text-left font-mono font-bold ${pnl >= 0 ? 'text-up' : 'text-down'}`;

            const elRoi = document.getElementById('final-roi');
            elRoi.innerText = roi.toFixed(2) + '%';
            elRoi.className = `text-left font-mono font-bold ${roi >= 0 ? 'text-up' : 'text-down'}`;

            document.getElementById('settle-modal').classList.remove('hidden');
        }

        // ==========================================
        // 9. 事件綁定
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initChart();

            document.getElementById('btn-start').addEventListener('click', startGame);
            document.getElementById('btn-reset').addEventListener('click', () => location.reload());
            document.getElementById('btn-buy').addEventListener('click', () => {
                if(state.isRunning) executeOrder('buy', document.getElementById('input-qty').value);
            });
            document.getElementById('btn-sell').addEventListener('click', () => {
                if(state.isRunning) executeOrder('sell', document.getElementById('input-qty').value);
            });
            document.getElementById('btn-flatten').addEventListener('click', flattenAll);

            // 策略開關
            document.getElementById('toggle-strategy').addEventListener('change', (e) => {
                state.strategyActive = e.target.checked;
                const status = document.getElementById('strategy-status');
                if (state.strategyActive) {
                    status.innerText = "監控中...";
                    status.classList.add("text-green-400");
                    logStrategy(`策略已啟動 [${state.currentStrategy}]`);
                } else {
                    status.innerText = "已暫停";
                    status.classList.remove("text-green-400");
                    logStrategy("策略已停止");
                }
            });

            // 策略選擇
            const strategySelector = document.getElementById('strategy-selector');
            const strategyDesc = document.getElementById('strategy-desc');
            const monitorTitle = document.getElementById('monitor-title');

            strategySelector.addEventListener('change', (e) => {
                state.currentStrategy = e.target.value;
                if (e.target.value === 'ma_cross') {
                    strategyDesc.innerText = "邏輯: SMA(5) 上穿 SMA(20) 買進，下穿賣出。";
                    monitorTitle.innerHTML = '<i class="fa-solid fa-code mr-1"></i>Pine: MA Cross';
                } else {
                    strategyDesc.innerText = "邏輯: 跌破 BB 下軌買進 (超賣)，突破上軌賣出 (超買)。";
                    monitorTitle.innerHTML = '<i class="fa-solid fa-wave-square mr-1"></i>Pine: B-Bands';
                }
                logStrategy(`策略切換為: ${e.target.options[e.target.selectedIndex].text}`);
            });

            document.getElementById('btn-modal-close').addEventListener('click', () => {
                document.getElementById('settle-modal').classList.add('hidden');
            });
        });
    </script>
</body>
</html>