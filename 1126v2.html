<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台指期模擬交易戰情室 - 全策略旗艦版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TradingView Lightweight Charts (v4.1.1) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        .text-up { color: #ff333a; }
        .text-down { color: #00b050; }
        .bg-up { background-color: #ff333a; }
        .bg-down { background-color: #00b050; }
        .border-up { border-color: #ff333a; }
        .border-down { border-color: #00b050; }
        .btn-trade:active { transform: scale(0.95); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .panel { background-color: #1e293b; border: 1px solid #334155; border-radius: 6px; }
        @keyframes flash-red { 0% { background-color: rgba(255, 51, 58, 0.5); } 100% { background-color: transparent; } }
        @keyframes flash-green { 0% { background-color: rgba(0, 176, 80, 0.5); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-red 0.5s ease-out; }
        .flash-down { animation: flash-green 0.5s ease-out; }
        
        /* Layout Helpers */
        .chart-wrapper { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #chart-main { flex: 1; position: relative; width: 100%; transition: height 0.3s ease; }
        #chart-sub { height: 0; overflow: hidden; border-top: 1px solid #334155; position: relative; width: 100%; transition: height 0.3s ease; }
        .sub-chart-visible #chart-main { height: 70%; }
        .sub-chart-visible #chart-sub { height: 30%; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-4 bg-slate-900 border-b border-slate-700 shrink-0">
        <div class="flex items-center gap-4">
            <div class="text-xl font-bold text-yellow-500"><i class="fa-solid fa-chart-line mr-2"></i>台指期戰情室</div>
            <div class="text-sm text-slate-400">代號: <span class="text-white font-mono">TXF</span></div>
            <div id="price-display" class="text-2xl font-mono font-bold text-white transition-colors">18000</div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-center">
                <div class="text-xs text-slate-400">權益數</div>
                <div id="equity-display" class="text-xl font-mono font-bold text-white">1,000,000</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-slate-400">未平倉損益</div>
                <div id="pnl-display" class="text-xl font-mono font-bold text-slate-500">0</div>
            </div>
            <div class="text-center border-l border-slate-700 pl-6">
                <div class="text-xs text-slate-400">剩餘時間</div>
                <div id="timer-display" class="text-2xl font-mono font-bold text-yellow-400">00:00</div>
            </div>
        </div>
        <div>
            <button id="btn-settings" class="p-2 text-slate-400 hover:text-white"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left: Charts Area -->
        <div class="flex-1 border-r border-slate-700 relative flex flex-col">
            <div id="chart-area-wrapper" class="chart-wrapper">
                <div id="chart-main">
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-slate-800 text-6xl font-bold pointer-events-none select-none opacity-20">TXF 模擬</div>
                </div>
                <div id="chart-sub"></div>
            </div>
            
            <!-- Strategy Monitor -->
            <div class="h-32 bg-slate-900 border-t border-slate-700 flex flex-col shrink-0">
                <div class="px-3 py-1 bg-slate-800 text-xs font-bold text-blue-400 flex justify-between">
                    <span id="monitor-title"><i class="fa-solid fa-code mr-1"></i>策略監視器</span>
                    <span id="strategy-status" class="text-slate-400">等待訊號...</span>
                </div>
                <div id="strategy-logs" class="flex-1 overflow-y-auto p-2 text-xs font-mono text-slate-300">
                    <div class="text-slate-500">// 系統就緒。請選擇策略開始...</div>
                </div>
            </div>
        </div>

        <!-- Right: Control Panel -->
        <div class="w-80 bg-slate-800 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-700 bg-slate-800">
                <label class="text-xs text-slate-400 block mb-1">競賽時間 (分鐘)</label>
                <div class="flex gap-2 mb-3">
                    <input type="number" id="input-duration" value="5" min="1" max="60" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white text-center">
                    <button id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white rounded font-bold text-sm transition"><i class="fa-solid fa-play mr-1"></i>開始</button>
                    <button id="btn-reset" class="w-10 bg-slate-700 hover:bg-slate-600 text-white rounded transition" title="重置"><i class="fa-solid fa-rotate-left"></i></button>
                </div>
                <div class="flex justify-between text-xs text-slate-500">
                    <span>保證金: <span class="text-slate-300">167,000</span></span>
                    <span>1點: <span class="text-slate-300">200 TWD</span></span>
                </div>
            </div>

            <div class="p-4 flex-1 flex flex-col gap-4 overflow-y-auto">
                <!-- Manual Trade -->
                <div class="panel p-3">
                    <div class="text-xs text-slate-400 mb-2 font-bold">手動交易 (市價)</div>
                    <div class="flex gap-2 h-16">
                        <button id="btn-buy" class="btn-trade flex-1 bg-slate-700 border border-slate-600 hover:border-red-500 hover:bg-slate-700/80 rounded flex flex-col items-center justify-center transition group relative overflow-hidden" disabled>
                            <span class="text-red-500 font-bold text-lg">買進</span>
                            <span class="text-xs text-slate-400">Buy</span>
                        </button>
                        <button id="btn-sell" class="btn-trade flex-1 bg-slate-700 border border-slate-600 hover:border-green-500 hover:bg-slate-700/80 rounded flex flex-col items-center justify-center transition group relative overflow-hidden" disabled>
                            <span class="text-green-500 font-bold text-lg">賣出</span>
                            <span class="text-xs text-slate-400">Sell</span>
                        </button>
                    </div>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-xs text-slate-400">口數:</span>
                        <input type="number" id="input-qty" value="1" min="1" max="10" class="w-16 bg-slate-900 border border-slate-600 rounded text-center text-sm">
                    </div>
                </div>

                <!-- Strategy Selector -->
                <div class="panel p-3">
                    <div class="mb-3">
                        <label class="text-xs text-slate-400 font-bold block mb-1">策略選擇</label>
                        <select id="strategy-selector" class="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs text-white focus:border-blue-500 focus:outline-none">
                            <option value="ma_cross">1. 均線交叉 (MA Cross)</option>
                            <option value="bb_reversion">2. 布林通道 (B-Bands)</option>
                            <option value="kd_cross">3. KD 隨機指標 (Stochastic)</option>
                            <option value="rsi_strategy">4. RSI 相對強弱指標</option>
                            <option value="macd_cross">5. MACD 指標</option>
                            <option value="ichimoku">6. 一目均衡表 (Ichimoku)</option>
                        </select>
                    </div>

                    <div class="flex justify-between items-center mb-2">
                        <div class="text-xs text-slate-400 font-bold">Auto-Trade (自動交易)</div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-strategy" class="sr-only peer" disabled>
                            <div class="w-9 h-5 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="strategy-desc" class="text-[10px] text-slate-500 leading-tight">
                        邏輯: SMA(5) 上穿 SMA(20) 買進，下穿賣出。
                    </div>
                </div>

                <!-- Position Info -->
                <div class="panel p-3 flex-1 flex flex-col">
                    <div class="text-xs text-slate-400 mb-2 font-bold flex justify-between items-center">
                        <span>目前持倉</span>
                        <button id="btn-flatten" class="px-2 py-0.5 bg-slate-600 hover:bg-slate-500 text-[10px] rounded text-white" disabled>全部平倉</button>
                    </div>
                    <div id="position-info" class="flex-1 flex flex-col items-center justify-center text-slate-500 gap-2">
                        <i class="fa-solid fa-box-open text-3xl opacity-30"></i>
                        <span class="text-sm">無持倉</span>
                    </div>
                </div>

                <!-- Trade Log -->
                <div class="panel p-3 h-32 overflow-hidden flex flex-col">
                    <div class="text-xs text-slate-400 mb-1 font-bold">最新成交</div>
                    <div id="trade-log" class="flex-1 overflow-y-auto text-xs font-mono space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 border-t border-slate-700 p-2 flex justify-between items-center text-xs text-slate-500 shrink-0 select-none">
        <div><i class="fa-solid fa-circle-info mr-1"></i>2025 © Ai FinTecg Corp. 本系統僅供教學使用。</div>
        <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-3 py-1 rounded transition flex items-center gap-1"><i class="fa-solid fa-house"></i> <a href="index.html" class="home-btn">回主頁</a></button>
    </footer>

    <!-- Settle Modal -->
    <div id="settle-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-lg p-8 max-w-md w-full text-center shadow-2xl">
            <div class="text-4xl mb-4 text-yellow-400"><i class="fa-solid fa-trophy"></i></div>
            <h2 class="text-2xl font-bold text-white mb-2">回合結算</h2>
            <p class="text-slate-400 mb-6 text-sm">本次交易競賽已結束，所有部位已自動平倉。</p>
            <div class="bg-slate-900 rounded p-4 mb-4 grid grid-cols-2 gap-4">
                <div class="text-right text-slate-400 text-sm">初始權益:</div><div class="text-left font-mono text-white">1,000,000</div>
                <div class="text-right text-slate-400 text-sm">最終權益:</div><div id="final-equity" class="text-left font-mono font-bold text-white">--</div>
                <div class="text-right text-slate-400 text-sm">總損益:</div><div id="final-pnl" class="text-left font-mono font-bold text-white">--</div>
                <div class="text-right text-slate-400 text-sm">報酬率:</div><div id="final-roi" class="text-left font-mono font-bold text-white">--</div>
            </div>
            <div class="text-xs text-slate-500 mb-6">* 已扣除最終平倉之手續費與交易稅</div>
            <button id="btn-modal-close" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded font-bold w-full transition">確定</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. Config
        // ==========================================
        const CONFIG = {
            initialCapital: 1000000, pointValue: 200, feePerOrder: 50, taxRate: 0.00002,
            startPrice: 18000, tickInterval: 500,
            colors: {
                up: '#ff333a', down: '#00b050',
                candleUp: '#ff333a', candleDown: '#00b050',
                wickUp: '#ff333a', wickDown: '#00b050',
                ma5: '#fbbf24', ma20: '#3b82f6', bb: 'rgba(192, 132, 252, 0.8)',
                kdK: '#fbbf24', kdD: '#3b82f6',
                rsi: '#e91e63',
                macdDif: '#fbbf24', macdDea: '#3b82f6',
                ichiTenkan: '#ef4444', ichiKijun: '#3b82f6'
            }
        };

        // ==========================================
        // 2. State
        // ==========================================
        const state = {
            isRunning: false, timeRemaining: 0, equity: CONFIG.initialCapital, position: 0, avgPrice: 0,
            currentPrice: CONFIG.startPrice, candles: [], currentCandle: null,
            strategyActive: false, currentStrategy: 'ma_cross',
            // Indicators Memory
            lastK: 50, lastD: 50, // For KD
            macdEma12: null, macdEma26: null, macdDea: null // For MACD
        };

        let timerInterval, tickInterval;
        let chartMain, chartSub; // Charts
        let series = {}; // Store all series

        // ==========================================
        // 3. Chart Init
        // ==========================================
        function initCharts() {
            // Main Chart
            chartMain = LightweightCharts.createChart(document.getElementById('chart-main'), {
                layout: { background: { type: 'solid', color: '#0f172a' }, textColor: '#94a3b8' },
                grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                timeScale: { timeVisible: true, secondsVisible: true },
                rightPriceScale: { borderVisible: false }
            });

            series.candle = chartMain.addCandlestickSeries({
                upColor: CONFIG.colors.candleUp, downColor: CONFIG.colors.candleDown,
                borderUpColor: CONFIG.colors.wickUp, borderDownColor: CONFIG.colors.wickDown,
                wickUpColor: CONFIG.colors.wickUp, wickDownColor: CONFIG.colors.wickDown
            });

            // Indicators (Hidden by default or empty)
            series.ma5 = chartMain.addLineSeries({ color: CONFIG.colors.ma5, lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            series.ma20 = chartMain.addLineSeries({ color: CONFIG.colors.ma20, lineWidth: 2, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            series.bbUpper = chartMain.addLineSeries({ color: CONFIG.colors.bb, lineWidth: 1, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            series.bbLower = chartMain.addLineSeries({ color: CONFIG.colors.bb, lineWidth: 1, lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            
            // Ichimoku Lines
            series.ichiTenkan = chartMain.addLineSeries({ color: CONFIG.colors.ichiTenkan, lineWidth: 2, title: 'Tenkan', lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });
            series.ichiKijun = chartMain.addLineSeries({ color: CONFIG.colors.ichiKijun, lineWidth: 2, title: 'Kijun', lastValueVisible: false, priceLineVisible: false, crosshairMarkerVisible: false });

            // Sub Chart
            chartSub = LightweightCharts.createChart(document.getElementById('chart-sub'), {
                layout: { background: { type: 'solid', color: '#0f172a' }, textColor: '#94a3b8' },
                grid: { vertLines: { color: '#1e293b' }, horzLines: { color: '#1e293b' } },
                timeScale: { visible: false }, // Sync manually-ish via data, usually need to sync logical range but for sim tick updates it's fine
                rightPriceScale: { borderVisible: false }
            });

            // Sub Series (Reused based on strategy)
            series.subLine1 = chartSub.addLineSeries({ color: CONFIG.colors.kdK, lineWidth: 2 });
            series.subLine2 = chartSub.addLineSeries({ color: CONFIG.colors.kdD, lineWidth: 2 });
            series.subHist = chartSub.addHistogramSeries({ color: '#26a69a' });

            // Volume (Main chart overlay)
            series.volume = chartMain.addHistogramSeries({ color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '' });
            series.volume.priceScale().applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

            // Sync Resize
            new ResizeObserver(entries => {
                if (entries.length === 0 || !entries[0].contentRect) return;
                const { width, height } = entries[0].contentRect;
                chartMain.resize(width, height);
            }).observe(document.getElementById('chart-main'));
            
            new ResizeObserver(entries => {
                if (entries.length === 0 || !entries[0].contentRect) return;
                const { width, height } = entries[0].contentRect;
                chartSub.resize(width, height);
            }).observe(document.getElementById('chart-sub'));
        }

        // ==========================================
        // 4. Logic & Math
        // ==========================================
        // Common
        const getHigh = (data, p) => Math.max(...data.slice(-p).map(c => c.high));
        const getLow = (data, p) => Math.min(...data.slice(-p).map(c => c.low));
        const getClose = (data) => data[data.length - 1].close;

        function calcSMA(data, p) {
            if (data.length < p) return null;
            return data.slice(-p).reduce((a, b) => a + b.close, 0) / p;
        }

        function calcRSI(data, p) {
            if (data.length < p + 1) return null;
            // Simple RSI impl
            let gains = 0, losses = 0;
            for (let i = data.length - p; i < data.length; i++) {
                const diff = data[i].close - data[i-1].close;
                if (diff >= 0) gains += diff; else losses -= diff;
            }
            const rs = gains / (losses === 0 ? 1 : losses); // Simple avg
            return 100 - (100 / (1 + rs));
        }

        function calcKD(data, p) {
            // RSV = (Close - LowestLow_9) / (HighestHigh_9 - LowestLow_9) * 100
            if (data.length < p) return { k: state.lastK, d: state.lastD };
            const c = data[data.length - 1].close;
            const l = getLow(data, p);
            const h = getHigh(data, p);
            let rsv = 50;
            if (h !== l) rsv = ((c - l) / (h - l)) * 100;
            
            const k = (2/3) * state.lastK + (1/3) * rsv;
            const d = (2/3) * state.lastD + (1/3) * k;
            
            // Update state
            state.lastK = k;
            state.lastD = d;
            return { k, d };
        }

        function calcMACD(price) {
            // EMA logic
            if (state.macdEma12 === null) {
                state.macdEma12 = price;
                state.macdEma26 = price;
                state.macdDea = 0;
                return { dif: 0, dea: 0, hist: 0 };
            }
            state.macdEma12 = state.macdEma12 * (11/13) + price * (2/13);
            state.macdEma26 = state.macdEma26 * (25/27) + price * (2/27);
            const dif = state.macdEma12 - state.macdEma26;
            state.macdDea = state.macdDea * (8/10) + dif * (2/10);
            return { dif, dea: state.macdDea, hist: 2 * (dif - state.macdDea) };
        }

        function calcIchimoku(data) {
            if (data.length < 26) return { tenkan: null, kijun: null };
            const tenkan = (getHigh(data, 9) + getLow(data, 9)) / 2;
            const kijun = (getHigh(data, 26) + getLow(data, 26)) / 2;
            return { tenkan, kijun };
        }

        // ==========================================
        // 5. Engine
        // ==========================================
        function generateTick(timeOverride) {
            const now = timeOverride || Math.floor(Date.now() / 1000);
            const volatility = 6;
            const change = (Math.random() - 0.5) * volatility * 2;
            let price = state.currentPrice + change;
            price = Math.round(price * 100) / 100;
            state.currentPrice = price;

            // 5s Candle Resolution
            const candleTime = Math.floor(now / 5) * 5;

            if (!state.currentCandle || state.currentCandle.time !== candleTime) {
                if (state.currentCandle) {
                    state.candles.push(state.currentCandle);
                    if (state.candles.length > 200) state.candles.shift();
                }
                state.currentCandle = { time: candleTime, ...state.currentCandle }; // Fix potential mutation issue
                state.currentCandle = { time: candleTime, open: price, high: price, low: price, close: price, volume: Math.floor(Math.random() * 5) };
            } else {
                state.currentCandle.high = Math.max(state.currentCandle.high, price);
                state.currentCandle.low = Math.min(state.currentCandle.low, price);
                state.currentCandle.close = price;
                state.currentCandle.volume += Math.floor(Math.random() * 2);
            }

            series.candle.update(state.currentCandle);
            series.volume.update({ time: candleTime, value: state.currentCandle.volume, color: state.currentCandle.close >= state.currentCandle.open ? 'rgba(255,51,58,0.3)' : 'rgba(0,176,80,0.3)' });

            updateUI(price, change);
            updatePnL(); // Added call to update PnL on every tick
            updateIndicatorsAndStrategy();
        }

        function updateIndicatorsAndStrategy() {
            const hist = [...state.candles, state.currentCandle];
            const time = state.currentCandle.time;
            const c = state.currentCandle.close;

            // 1. MA & BB (Always calc basics if needed, or just specific)
            // Reset visibility
            resetVisibility();

            const strat = state.currentStrategy;
            let buySignal = false, sellSignal = false;
            let signalText = "";

            if (strat === 'ma_cross') {
                const sma5 = calcSMA(hist, 5);
                const sma20 = calcSMA(hist, 20);
                if (sma5 && sma20) {
                    series.ma5.update({ time, value: sma5 });
                    series.ma20.update({ time, value: sma20 });
                    // Logic
                    if (sma5 > sma20) buySignal = true; 
                    if (sma5 < sma20) sellSignal = true;
                    signalText = "MA黃金/死亡交叉";
                }
            } 
            else if (strat === 'bb_reversion') {
                const sma20 = calcSMA(hist, 20);
                if (sma20) {
                    // Calc SD
                    const slice = hist.slice(-20);
                    const sumSq = slice.reduce((a, b) => a + Math.pow(b.close - sma20, 2), 0);
                    const sd = Math.sqrt(sumSq / 20);
                    const upper = sma20 + 2 * sd;
                    const lower = sma20 - 2 * sd;

                    series.ma20.update({ time, value: sma20 }); // Middle
                    series.bbUpper.update({ time, value: upper });
                    series.bbLower.update({ time, value: lower });

                    if (c < lower) { buySignal = true; signalText = "跌破BB下軌(超賣)"; }
                    if (c > upper) { sellSignal = true; signalText = "突破BB上軌(超買)"; }
                }
            }
            else if (strat === 'kd_cross') {
                const { k, d } = calcKD(hist, 9);
                series.subLine1.update({ time, value: k }); // Yellow K
                series.subLine2.update({ time, value: d }); // Blue D
                series.subHist.setData([]); // Clear hist
                
                // Logic: K cross D
                if (k > d && k < 80) { buySignal = true; signalText = "KD黃金交叉"; }
                if (k < d && k > 20) { sellSignal = true; signalText = "KD死亡交叉"; }
            }
            else if (strat === 'rsi_strategy') {
                const rsi = calcRSI(hist, 14);
                if (rsi) {
                    series.subLine1.update({ time, value: rsi });
                    series.subLine2.setData([]); // Hide second line
                    
                    // Logic: Cross 30/70
                    if (rsi < 30) { buySignal = true; signalText = "RSI低檔鈍化(超賣)"; }
                    if (rsi > 70) { sellSignal = true; signalText = "RSI高檔鈍化(超買)"; }
                }
            }
            else if (strat === 'macd_cross') {
                const { dif, dea, hist: h } = calcMACD(c);
                series.subLine1.update({ time, value: dif });
                series.subLine2.update({ time, value: dea });
                series.subHist.update({ time, value: h, color: h >= 0 ? CONFIG.colors.up : CONFIG.colors.down });

                if (dif > dea && h > 0) { buySignal = true; signalText = "MACD黃金交叉"; }
                if (dif < dea && h < 0) { sellSignal = true; signalText = "MACD死亡交叉"; }
            }
            else if (strat === 'ichimoku') {
                const { tenkan, kijun } = calcIchimoku(hist);
                if (tenkan && kijun) {
                    series.ichiTenkan.update({ time, value: tenkan });
                    series.ichiKijun.update({ time, value: kijun });
                    
                    if (tenkan > kijun) { buySignal = true; signalText = "一目均衡表轉折(多)"; }
                    if (tenkan < kijun) { sellSignal = true; signalText = "一目均衡表轉折(空)"; }
                }
            }

            // Execute Strategy
            if (state.strategyActive && state.isRunning && state.candles.length > 5) { // Warmup check
                 // Simple latch: Don't spam trades, only on crossover detection ideally.
                 // Current simulation simple logic: if condition met, ensure position.
                 executeStrategy(buySignal, sellSignal, signalText);
            }
        }

        let lastTradeSignal = null;
        function executeStrategy(buy, sell, reason) {
            // Simple flip-flop strategy
            if (buy && lastTradeSignal !== 'BUY') {
                lastTradeSignal = 'BUY';
                logStrategy(`Signal: BUY - ${reason} @ ${state.currentPrice}`);
                series.candle.setMarkers([{ time: state.currentCandle.time, position: 'belowBar', color: '#2196F3', shape: 'arrowUp', text: 'L' }]);
                if (state.position < 0) executeOrder('buy', Math.abs(state.position));
                if (state.position === 0) executeOrder('buy', 1);
            } else if (sell && lastTradeSignal !== 'SELL') {
                lastTradeSignal = 'SELL';
                logStrategy(`Signal: SELL - ${reason} @ ${state.currentPrice}`);
                series.candle.setMarkers([{ time: state.currentCandle.time, position: 'aboveBar', color: '#e91e63', shape: 'arrowDown', text: 'S' }]);
                if (state.position > 0) executeOrder('sell', Math.abs(state.position));
                if (state.position === 0) executeOrder('sell', 1);
            }
        }

        function resetVisibility() {
            // Determine visibility based on strategy
            const s = state.currentStrategy;
            const isSub = ['kd_cross', 'rsi_strategy', 'macd_cross'].includes(s);
            
            // Layout Toggle
            const wrapper = document.getElementById('chart-area-wrapper');
            if (isSub) wrapper.classList.add('sub-chart-visible');
            else wrapper.classList.remove('sub-chart-visible');

            // Data clearing or hiding logic simulation (Lightweight charts hides lines if no data update? No, better to set data empty if switch)
            // Real implementation: we can't easily "hide" series without removing. 
            // Workaround: We just update the active ones. The old lines will stay frozen.
            // Cleaner: clear data of inactive series on strategy change.
        }

        function clearInactiveSeries() {
            const s = state.currentStrategy;
            // Removed clearing logic that was causing flashing or data issues during live updates
            // Instead, we will clear all indicator series on startGame only.
            // During switch, we just let them be "frozen" or overwritten.
        }
        
        function clearAllSeriesData() {
             series.candle.setData([]);
             series.volume.setData([]);
             series.ma5.setData([]);
             series.ma20.setData([]);
             series.bbUpper.setData([]);
             series.bbLower.setData([]);
             series.ichiTenkan.setData([]);
             series.ichiKijun.setData([]);
             series.subLine1.setData([]);
             series.subLine2.setData([]);
             series.subHist.setData([]);
        }

        // ==========================================
        // 6. Orders & Game
        // ==========================================
        function executeOrder(side, qty) {
            qty = parseInt(qty);
            const price = state.currentPrice;
            const cost = qty * CONFIG.feePerOrder + (price * CONFIG.pointValue * qty * CONFIG.taxRate);
            state.equity -= cost;

            if (side === 'buy') {
                if (state.position < 0) { 
                    const cover = Math.min(qty, Math.abs(state.position));
                    state.equity += (state.avgPrice - price) * cover * CONFIG.pointValue;
                    state.position += cover; qty -= cover;
                    logTrade(`平空 ${cover} @ ${price}`);
                }
                if (qty > 0) {
                    const newVal = (state.position * state.avgPrice) + (qty * price);
                    state.position += qty; state.avgPrice = newVal / state.position;
                    logTrade(`買多 ${qty} @ ${price}`);
                }
            } else { 
                if (state.position > 0) {
                    const cover = Math.min(qty, state.position);
                    state.equity += (price - state.avgPrice) * cover * CONFIG.pointValue;
                    state.position -= cover; qty -= cover;
                    logTrade(`平多 ${cover} @ ${price}`);
                }
                if (qty > 0) {
                    const newVal = (Math.abs(state.position) * state.avgPrice) + (qty * price);
                    state.position -= qty; state.avgPrice = newVal / Math.abs(state.position);
                    logTrade(`賣空 ${qty} @ ${price}`);
                }
            }
            updatePositionUI(); updatePnL();
        }

        function updateUI(price, change) {
            const el = document.getElementById('price-display');
            el.innerText = price.toFixed(0);
            el.className = `text-2xl font-mono font-bold transition-colors ${change >= 0 ? 'text-up flash-up' : 'text-down flash-down'}`;
            setTimeout(() => el.className = el.className.replace(/flash-\w+/, ''), 500);
        }

        function updatePnL() {
            let unrealized = 0;
            if (state.position !== 0) unrealized = (state.currentPrice - state.avgPrice) * state.position * CONFIG.pointValue;
            const el = document.getElementById('pnl-display');
            el.innerText = Math.round(unrealized).toLocaleString();
            el.className = `text-xl font-mono font-bold ${unrealized > 0 ? 'text-up' : unrealized < 0 ? 'text-down' : 'text-slate-500'}`;
            document.getElementById('equity-display').innerText = Math.round(state.equity + unrealized).toLocaleString();
        }

        function updatePositionUI() {
            const div = document.getElementById('position-info');
            const btn = document.getElementById('btn-flatten');
            if (state.position === 0) {
                div.innerHTML = `<i class="fa-solid fa-box-open text-3xl opacity-30"></i><span class="text-sm">無持倉</span>`;
                btn.disabled = true;
            } else {
                const color = state.position > 0 ? 'text-up' : 'text-down';
                div.innerHTML = `<div class="text-lg font-bold ${color}">${state.position > 0 ? '多單' : '空單'} ${Math.abs(state.position)}</div><div class="text-xs text-slate-400">均價 ${state.avgPrice.toFixed(0)}</div>`;
                btn.disabled = false;
            }
        }

        function logTrade(msg) {
            const logs = document.getElementById('trade-log');
            const d = document.createElement('div');
            d.innerHTML = `<span class="text-slate-500 text-[10px]">${new Date().toLocaleTimeString()}</span> ${msg}`;
            logs.prepend(d);
        }

        function logStrategy(msg) {
            const logs = document.getElementById('strategy-logs');
            const d = document.createElement('div');
            d.innerHTML = `<span class="text-slate-500">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logs.prepend(d);
        }

        // ==========================================
        // 7. Loop & Controls
        // ==========================================
        function startGame() {
            // STOP Intervals First
            if (tickInterval) clearInterval(tickInterval);
            if (timerInterval) clearInterval(timerInterval);

            state.isRunning = true;
            state.timeRemaining = parseInt(document.getElementById('input-duration').value) * 60;
            state.equity = CONFIG.initialCapital;
            state.position = 0;
            state.currentPrice = CONFIG.startPrice;
            state.candles = []; state.currentCandle = null;
            lastTradeSignal = null;
            
            // Reset Charts COMPLETELY
            clearAllSeriesData();
            document.getElementById('trade-log').innerHTML = '';
            document.getElementById('strategy-logs').innerHTML = '';
            
            toggleControls(true);
            prefillData(60);
            
            tickInterval = setInterval(() => generateTick(), CONFIG.tickInterval);
            timerInterval = setInterval(() => {
                state.timeRemaining--;
                const m = Math.floor(state.timeRemaining / 60).toString().padStart(2,'0');
                const s = (state.timeRemaining % 60).toString().padStart(2,'0');
                const el = document.getElementById('timer-display');
                el.innerText = `${m}:${s}`;
                el.className = `text-2xl font-mono font-bold ${state.timeRemaining < 10 ? 'text-red-500' : 'text-yellow-400'}`;
                if (state.timeRemaining <= 0) endGame();
            }, 1000);
        }

        function prefillData(n) {
            const now = Math.floor(Date.now() / 1000);
            for(let i=0; i<n; i++) {
                const t = now - (n-i)*5;
                for(let k=0; k<3; k++) generateTick(t);
            }
        }

        function endGame() {
            state.isRunning = false;
            clearInterval(tickInterval); clearInterval(timerInterval);
            if(state.position !== 0) {
                const side = state.position > 0 ? 'sell' : 'buy';
                executeOrder(side, Math.abs(state.position));
            }
            updatePnL();
            toggleControls(false);
            
            const pnl = Math.round(state.equity - CONFIG.initialCapital);
            const roi = (pnl / CONFIG.initialCapital) * 100;
            const color = pnl >= 0 ? 'text-up' : 'text-down';
            document.getElementById('final-equity').innerText = Math.round(state.equity).toLocaleString();
            document.getElementById('final-pnl').innerText = pnl.toLocaleString();
            document.getElementById('final-pnl').className = `text-left font-mono font-bold ${color}`;
            document.getElementById('final-roi').innerText = roi.toFixed(2) + '%';
            document.getElementById('final-roi').className = `text-left font-mono font-bold ${color}`;
            document.getElementById('settle-modal').classList.remove('hidden');
        }

        function toggleControls(enable) {
            document.getElementById('btn-buy').disabled = !enable;
            document.getElementById('btn-sell').disabled = !enable;
            document.getElementById('btn-flatten').disabled = !enable;
            document.getElementById('toggle-strategy').disabled = !enable;
            document.getElementById('strategy-selector').disabled = !enable;
            document.getElementById('btn-start').disabled = enable;
            document.getElementById('btn-buy').className = enable ? document.getElementById('btn-buy').className.replace('opacity-50', '') : document.getElementById('btn-buy').className + ' opacity-50';
            document.getElementById('btn-sell').className = enable ? document.getElementById('btn-sell').className.replace('opacity-50', '') : document.getElementById('btn-sell').className + ' opacity-50';
        }

        // ==========================================
        // 8. Events
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            document.getElementById('btn-start').addEventListener('click', startGame);
            document.getElementById('btn-reset').addEventListener('click', () => location.reload());
            document.getElementById('btn-buy').addEventListener('click', () => { if(state.isRunning) executeOrder('buy', document.getElementById('input-qty').value); });
            document.getElementById('btn-sell').addEventListener('click', () => { if(state.isRunning) executeOrder('sell', document.getElementById('input-qty').value); });
            document.getElementById('btn-flatten').addEventListener('click', () => { if(state.position !== 0) executeOrder(state.position > 0 ? 'sell' : 'buy', Math.abs(state.position)); });
            
            document.getElementById('toggle-strategy').addEventListener('change', (e) => {
                state.strategyActive = e.target.checked;
                const s = document.getElementById('strategy-status');
                s.innerText = state.strategyActive ? "監控中..." : "已暫停";
                s.className = state.strategyActive ? "text-green-400" : "text-slate-400";
            });

            document.getElementById('strategy-selector').addEventListener('change', (e) => {
                state.currentStrategy = e.target.value;
                clearInactiveSeries();
                resetVisibility();
                const desc = document.getElementById('strategy-desc');
                const title = document.getElementById('monitor-title');
                const map = {
                    'ma_cross': { t: 'MA Cross', d: 'SMA(5) 穿過 SMA(20)' },
                    'bb_reversion': { t: 'B-Bands', d: '價格突破通道上下緣' },
                    'kd_cross': { t: 'KD Stochastic', d: 'K值穿越D值 (黃金/死亡交叉)' },
                    'rsi_strategy': { t: 'RSI', d: 'RSI > 70 超買, < 30 超賣' },
                    'macd_cross': { t: 'MACD', d: 'DIF 穿過 DEA 且柱狀圖翻轉' },
                    'ichimoku': { t: 'Ichimoku', d: '一目均衡表轉換線/基準線交叉' }
                };
                title.innerHTML = `<i class="fa-solid fa-code mr-1"></i>Pine: ${map[state.currentStrategy].t}`;
                desc.innerText = `邏輯: ${map[state.currentStrategy].d}`;
            });

            document.getElementById('btn-modal-close').addEventListener('click', () => document.getElementById('settle-modal').classList.add('hidden'));
        });
    </script>
</body>
</html>