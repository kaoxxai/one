<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 2 HTML 服務</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tech: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(14, 165, 233, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: #ffffff;
            color: #1e293b;
        }
        .drop-active {
            border-color: #0ea5e9 !important;
            background-color: #f0f9ff !important;
            transform: scale(1.01);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .preview-card {
            transition: all 0.3s ease;
        }
        .preview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- 頁首 -->
    <header class="w-full bg-white border-b border-gray-100 py-6 sticky top-0 z-50 bg-opacity-90 backdrop-blur-md">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-tech-500 rounded-lg flex items-center justify-center text-white shadow-glow">
                    <i class="fa-solid fa-file-code text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-gray-800">PDF 檔轉 HTML <span class="text-tech-500">引擎</span></h1>
            </div>
            <div class="text-sm text-gray-500 font-medium">Fast • Secure • Client-side</div>
        </div>
    </header>

    <!-- 主要內容區 -->
    <main class="flex-grow container mx-auto px-4 py-8 max-w-5xl">
        
        <!-- 使用說明欄 -->
        <section class="mb-8 bg-tech-50 rounded-xl p-6 border border-tech-100 shadow-sm relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-tech-500 opacity-5 rounded-full -mr-16 -mt-16 pointer-events-none"></div>
            <h2 class="text-lg font-bold text-tech-900 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-circle-info text-tech-500"></i> 使用說明
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                <ul class="space-y-2">
                    <li class="flex items-start gap-2"><span class="bg-white text-tech-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold border border-tech-100">1</span> 點擊下方區域或拖曳上傳 PDF 檔案。</li>
                    <li class="flex items-start gap-2"><span class="bg-white text-tech-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold border border-tech-100">2</span> 確認檔名無誤後，點擊「一鍵轉換」。</li>
                </ul>
                <ul class="space-y-2">
                    <li class="flex items-start gap-2"><span class="bg-white text-tech-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold border border-tech-100">3</span> 在下方預覽區確認轉換結果。</li>
                    <li class="flex items-start gap-2"><span class="bg-white text-tech-500 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold border border-tech-100">4</span> 點擊下載按鈕取得壓縮檔。</li>
                </ul>
            </div>
        </section>

        <!-- 操作區塊 -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-8">
            
            <!-- 上傳區域 -->
            <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer transition-all duration-300 hover:border-tech-400 hover:bg-gray-50 group">
                <input type="file" id="file-input" class="hidden" accept=".pdf">
                <div id="upload-prompt">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 group-hover:text-tech-500 group-hover:bg-tech-50 transition-colors">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl"></i>
                    </div>
                    <p class="text-lg font-medium text-gray-700">點擊上傳 或 拖曳 PDF 至此</p>
                    <p class="text-sm text-gray-400 mt-2">支援單個 PDF 檔案</p>
                </div>
                <!-- 檔案顯示 (隱藏預設) -->
                <div id="file-info" class="hidden">
                    <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 border border-red-100">
                        <i class="fa-solid fa-file-pdf text-3xl"></i>
                    </div>
                    <p id="filename-display" class="text-xl font-bold text-gray-800 break-all"></p>
                    <p class="text-sm text-gray-500 mt-1" id="filesize-display"></p>
                    <button id="reupload-btn" class="mt-4 text-xs text-gray-400 hover:text-tech-500 underline">更換檔案</button>
                </div>
            </div>

            <!-- 按鈕控制區 -->
            <div class="flex flex-wrap gap-4 mt-6 justify-center">
                <button id="convert-btn" disabled class="px-8 py-3 bg-gradient-to-r from-tech-500 to-tech-600 text-white rounded-lg shadow-lg shadow-tech-500/30 hover:shadow-tech-500/50 hover:-translate-y-0.5 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> 一鍵轉換
                </button>
                
                <button id="download-btn" disabled class="hidden px-8 py-3 bg-gray-800 text-white rounded-lg shadow-lg hover:bg-gray-700 hover:-translate-y-0.5 transition-all font-semibold flex items-center gap-2">
                    <i class="fa-solid fa-file-zipper"></i> 下載壓縮檔案
                </button>

                <button id="clear-btn" class="px-6 py-3 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 hover:text-red-500 transition-colors font-medium flex items-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> 清除
                </button>
            </div>

            <!-- 進度條 -->
            <div id="progress-container" class="hidden mt-6 w-full max-w-lg mx-auto">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>Processing...</span>
                    <span id="progress-text">0%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                    <div id="progress-bar" class="bg-tech-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- 瀏覽視窗 -->
        <div id="preview-section" class="hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2 border-l-4 border-tech-500 pl-3">
                預覽視窗 <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-md" id="page-count-badge">0 Pages</span>
            </h3>
            
            <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 預覽項目將透過 JS 插入 -->
            </div>
        </div>

    </main>

    <!-- 頁尾 -->
    <footer class="bg-gray-50 border-t border-gray-200 py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-lg font-medium text-gray-700 mb-2">謝謝 使用</p>
            <a href="http:/www.aifinsys.com" class="inline-flex items-center gap-2 text-tech-500 hover:text-tech-600 font-semibold transition-colors border border-tech-200 px-4 py-2 rounded-full bg-white hover:bg-tech-50">
                <i class="fa-solid fa-house"></i> 回主頁
            </a>
            <p class="text-xs text-gray-400 mt-6">© 2025 Ai Fintech Corp. 2025 © All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // 初始化 PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // DOM 元素
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const uploadPrompt = document.getElementById('upload-prompt');
        const fileInfo = document.getElementById('file-info');
        const filenameDisplay = document.getElementById('filename-display');
        const filesizeDisplay = document.getElementById('filesize-display');
        const reuploadBtn = document.getElementById('reupload-btn');
        
        const convertBtn = document.getElementById('convert-btn');
        const clearBtn = document.getElementById('clear-btn');
        const downloadBtn = document.getElementById('download-btn');
        
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        const previewSection = document.getElementById('preview-section');
        const previewGrid = document.getElementById('preview-grid');
        const pageCountBadge = document.getElementById('page-count-badge');

        // 狀態變數
        let currentFile = null;
        let pdfDoc = null;
        let zip = null;

        // 拖曳事件處理
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('drop-active'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('drop-active'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);
        reuploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files: files } });
        }

        function handleFiles(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type !== 'application/pdf') {
                    alert('請上傳 PDF 檔案格式');
                    return;
                }
                currentFile = file;
                updateUIForFile(file);
            }
        }

        function updateUIForFile(file) {
            uploadPrompt.classList.add('hidden');
            fileInfo.classList.remove('hidden');
            filenameDisplay.textContent = file.name;
            filesizeDisplay.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            convertBtn.disabled = false;
            convertBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            // 重置之前的結果
            resetResults();
        }

        function resetResults() {
            downloadBtn.classList.add('hidden');
            previewSection.classList.add('hidden');
            previewGrid.innerHTML = '';
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            zip = null;
        }

        // 清除功能
        clearBtn.addEventListener('click', () => {
            currentFile = null;
            pdfDoc = null;
            fileInput.value = '';
            uploadPrompt.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            convertBtn.disabled = true;
            resetResults();
        });

        // 轉換核心邏輯
        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            convertBtn.disabled = true;
            convertBtn.innerHTML = '<div class="loader w-5 h-5 border-2 mr-2"></div> 轉換中...';
            progressContainer.classList.remove('hidden');
            previewSection.classList.remove('hidden');
            zip = new JSZip();

            try {
                const arrayBuffer = await currentFile.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                const totalPages = pdfDoc.numPages;
                pageCountBadge.textContent = `${totalPages} Pages`;

                for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                    await processPage(pageNum, totalPages);
                    
                    // 更新進度條
                    const percentage = Math.round((pageNum / totalPages) * 100);
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${percentage}%`;
                }

                // 完成處理
                finishConversion();

            } catch (error) {
                console.error(error);
                alert('轉換發生錯誤，請檢查檔案是否損毀。');
                convertBtn.disabled = false;
                convertBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> 一鍵轉換';
            }
        });

        async function processPage(pageNum, totalPages) {
            const page = await pdfDoc.getPage(pageNum);
            
            // 設定渲染比例 (1.5倍以保持清晰度)
            const scale = 1.5;
            const viewport = page.getViewport({ scale: scale });

            // 建立 Canvas
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            // 渲染頁面
            await page.render({
                canvasContext: context,
                viewport: viewport
            }).promise;

            // 轉為圖片數據
            const imgData = canvas.toDataURL('image/png');

            // 1. 生成 HTML 內容
            const htmlContent = generateHTMLTemplate(pageNum, imgData, viewport.width, viewport.height);
            
            // 2. 加入 ZIP
            zip.file(`page_${pageNum}.html`, htmlContent);

            // 3. 顯示預覽
            createPreviewItem(pageNum, imgData);
        }

        function createPreviewItem(pageNum, imgSrc) {
            const div = document.createElement('div');
            div.className = 'preview-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden';
            div.innerHTML = `
                <div class="bg-gray-50 border-b border-gray-100 px-4 py-2 flex justify-between items-center">
                    <span class="font-bold text-gray-600">Page ${pageNum}</span>
                    <i class="fa-solid fa-code text-tech-500 opacity-50"></i>
                </div>
                <div class="aspect-[1/1.4] w-full bg-gray-200 relative overflow-hidden group">
                    <img src="${imgSrc}" class="w-full h-full object-contain" alt="Page ${pageNum}">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
                    </div>
                </div>
            `;
            previewGrid.appendChild(div);
        }

        function generateHTMLTemplate(pageNum, imgData, width, height) {
            return `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page ${pageNum}</title>
    <style>
        body { margin: 0; padding: 20px; background: #f0f0f0; display: flex; justify-content: center; }
        .page-container { 
            background: white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            max-width: 100%; 
        }
        img { width: 100%; height: auto; display: block; }
    </style>
</head>
<body>
    <div class="page-container" style="max-width: ${width}px;">
        <img src="${imgData}" alt="PDF Page ${pageNum}">
    </div>
</body>
</html>`;
        }

        function finishConversion() {
            convertBtn.innerHTML = '<i class="fa-solid fa-check"></i> 轉換完成';
            convertBtn.classList.remove('from-tech-500', 'to-tech-600');
            convertBtn.classList.add('from-green-500', 'to-green-600');
            
            downloadBtn.classList.remove('hidden');
            downloadBtn.disabled = false;
        }

        // 下載功能
        downloadBtn.addEventListener('click', () => {
            if (!zip) return;
            
            const originalName = currentFile.name.replace(/\.pdf$/i, "");
            const zipFilename = `${originalName}+HTML.zip`;

            downloadBtn.innerHTML = '<div class="loader w-4 h-4 border-2 mr-2"></div> 打包中...';

            zip.generateAsync({ type: "blob" }).then(function(content) {
                const link = document.createElement("a");
                link.href = URL.createObjectURL(content);
                link.download = zipFilename;
                link.click();
                
                downloadBtn.innerHTML = '<i class="fa-solid fa-file-zipper"></i> 下載壓縮檔案';
            });
        });

    </script>
</body>
</html>